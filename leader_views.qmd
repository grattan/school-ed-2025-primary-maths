---
title: "Leaders' views"
author: "Nick Parkinson"
date: "18 July 2024"
format: 
  html:
    css: .formatting/grattan-style.css
    theme: lumen
    highlight: pygments
    toc: true
    toc_depth: 2
    number_sections: yes
    df_print: kable
    fig-height: 5.7
    fig-width: 8.75
    fig-cap-location: top
    fig-dpi: 300
lightbox: true
execute:
  echo: false
  warning: false
  cache: true
  freeze: auto
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: set-up
#| include: false

source("R/globals.R")
load(file = "data/clean_survey.Rdata")
```

## How do leaders feel?

```{r}
#| label: leaders_views
#| fig.height: 9
leader_view_labels <- clean_survey |> 
  select(starts_with("Q30")) |> 
  var_labels() |> 
  get_label() |> 
  str_replace_all(c("questions_for_leaders - " = "",
                  "\\s*\\([^\\)]+\\)" = ""))

leaders_views_df <- clean_survey |>
  select(starts_with("Q30")) |> 
  mutate(across(starts_with("Q30"), ~ case_when(
    . == "Agree" ~ T,
    . == "Strongly agree" ~ T,
    is.na(.) ~ NA,
    .default = F
  ))) |> 
  pivot_longer(everything(), names_to = "question", values_to = "response") |> 
  group_by(question) |> 
  summarise(mean = mean(response, na.rm = T), 
            se = sd(response, na.rm = T)  / sqrt(sum(!is.na(response))),
            n = sum(!is.na(response))) |> 
  mutate(label = leader_view_labels)

leaders_views_df |> 
  ggplot(aes(x = factor(str_wrap(label, 40)) |> fct_reorder(mean),
             y = mean, 
             ymin = mean - 1.65 * se, 
             ymax = mean + 1.65 * se)) +
  geom_col() +
  geom_errorbar(color = grattan_black,
                width = .2) +
  coord_flip() +
  # theme and labels
  theme_grattan(flipped = T,
                base_size = 14) +
  grattan_y_continuous(labels = percent) +
  labs(title = "Leaders feel ill-supported by government to improve maths teaching in their schools",
       subtitle = "Percent of leaders who agree or strongly agree (with 90 per cent confidence interval)",
       x = NULL, y = NULL,
       caption = glue("Notes: Total responses to statements varied by statement between {min(leaders_views_df$n) |> comma()} and {max(leaders_views_df$n) |> comma()}. {source_caption}"))
  
```

## To what extent are teachers' hesistant about upper primary?

```{r}
#| label: hesitations-about-upper-primary

clean_survey |> 
  drop_na(Q31) |> 
  tabulator::tab(Q31) |> 
  select(-cum_prop) |> 
  mutate(
    Q31 = factor(
           Q31, 
           levels = c(
             "No teachers",
             "Some teachers",
             "About half of teachers", 
             "Most teachers", 
             "All teachers"
         )),
    prop = percent(prop, 0.1)) |> 
  arrange(Q31) |> 
  kable(align = "lrr")
```

## 

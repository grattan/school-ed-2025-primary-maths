{"title":"Making it count: Improving primary school maths","markdown":{"yaml":{"title":"Making it count: Improving primary school maths","subtitle":"Analysis of Grattan Institute's survey of primary school teachers","date":"7 July 2024","author":"Nick Parkinson","format":{"html":{"css":".formatting/grattan-style.css","theme":"lumen","highlight":"pygments","toc":true,"toc_depth":2,"number_sections":"yes","df_print":"kable","fig-cap-location":"top","fig-dpi":300}},"execute":{"echo":false,"warning":false},"editor_options":{"chunk_output_type":"console"},"bibliography":"references.bib"},"headingText":"Import data","containsRefs":false,"markdown":"\n\n```{r}\n#| label: set-up\n#| include: false\n\nsource(\"R/globals.R\")\n\n```\n\n\nWe first import the data straight from Qualtrics following the instructions [here](https://api.qualtrics.com/instructions/ZG9jOjg3NjYzNQ-finding-your-qualtrics-i-ds). We also export a dated version of the survey, for file management.\n\n```{r}\n#| label: import\n#| include: false\n\n# To connect to the Qualtrics API, uncomment the following line of code the first time you run this  script, and then restart R.\n\nqualtrics_api_credentials(api_key = \"yKIwTusJkJAY9esZ4GQkqZKURN7Pq1RxI6vkvD4Q\", base_url = \"melbourneuni.au1.qualtrics.com\", install = TRUE, overwrite = TRUE)\n\nreadRenviron(\"~/.Renviron\")\n\nsurveys <- all_surveys()\n\nsurvey_id <- surveys |>\n  filter(str_detect(name, \"primary school mathematics\")) |>\n  pull(id)\n\n# Change the id below based on the id of the primary numeracy survey in your list of surveys.\nraw_survey_data <- fetch_survey(\n  surveyID = survey_id,\n  verbose = FALSE,\n  include_display_order = FALSE,\n  start_date = as.Date(\"2024-07-04\"),\n  breakout_sets = FALSE,\n  convert = FALSE\n)\n\n# Save the Qualtrics survey, just in case\ncurrentDate <- Sys.Date()\n\nfilename <- paste(\"data/survey\", currentDate, \".csv\", set = \"\")\n\n# write.csv(raw_survey_data, file = filename)\n\n# Check what data looks like\nraw_survey_data |>\n  select(matches(\"Q\\\\d+\") & !contains(c(\"DO\", \"TEXT\", \"Q6\", \"Q7\"))) |>\n  head(5) |>\n  kable() |>\n  row_spec(0:5, extra_css = \"height: 10px\")\n```\n\n# Filter to valid sample\n\nWe filter out:\n\n-   Anyone whose responses are [flagged by Qualtrics as suspicious](https://www.qualtrics.com/support/survey-platform/survey-module/survey-checker/fraud-detection/) (i.e. Q_RecaptchaScore is below 0.5). This is typically because of the speed at which they respond, or 'straight lining' (i.e. clicking the same radio buttons in a single column).\n\n-   Anyone who did not complete more than one substantive (i.e. non-demographic) question.\n\n```{r}\n#| label: clean_survey\n\ninitial_sample <- nrow(raw_survey_data)\n\nclean_survey <- raw_survey_data |>\n  filter(Q_RecaptchaScore >= 0.5) # filter out bots\n\nsubstantive_questions <- names(clean_survey)[which(names(clean_survey) == \"Q24\"):ncol(clean_survey) - 1]\n\n# Check if all values in each row from Q24 onwards are NA\nresponses_to_keep <- rowSums(is.na(clean_survey[substantive_questions])) < length(substantive_questions)\n\nclean_survey <- clean_survey[responses_to_keep, ]\n\ntotal_sample <- nrow(clean_survey)\n\n# Export survey\nsave(clean_survey, file = \"data/clean_survey.Rdata\")\n\n```\n\nThrough this process, we lose `r initial_sample - total_sample` responses. This leaves us with `r comma(total_sample)` valid responses.\n\nWe also check for duplicates, using [Qualtrics duplicate flag](https://www.qualtrics.com/support/survey-platform/survey-module/survey-checker/fraud-detection/). This pulls out respondents who try reattempt the survey from the same IP address. We can see if they are duplicates by looking through their answers manually.\n\n```{r}\n#| label: tab-check-for-duplicates\n#| caption: Extract of data from possible duplicates\n\npossible_duplicates <- clean_survey |>\n  filter(Q_BallotBoxStuffing) |>\n  select(ResponseId, IPAddress, matches(\"Q\")) |>\n  kable()\n```\n\nWe now check the number of valid responses over time, in @fig-responses-over-time.\n\n```{r}\n#| label: fig-responses-over-time\n#| fig-cap: \"Number of responses over time\"\nclean_survey |>\n  rowid_to_column() |>\n  ggplot(aes(x = RecordedDate, y = rowid)) +\n  geom_line() +\n  theme_grattan() +\n  scale_x_datetime(\n    date_labels = \"%d-%b\",\n  ) +\n  scale_y_continuous_grattan() +\n  labs(x = NULL)\n```\n\n```{r}\n#| echo: false\n#| output: false\n# Check the WA responses over time: Did the WA department actually share the survey?\nclean_survey |>\n  filter(Q19 == \"WA\") |> \n  rowid_to_column() |>\n  ggplot(aes(x = RecordedDate, y = rowid)) +\n  geom_line() +\n  geom_vline(xintercept = dmy(\"30/07/2024\")) +\n  theme_grattan() +\n  scale_x_datetime(\n    date_labels = \"%d-%b\",\n  ) +\n  scale_y_continuous_grattan() +\n  labs(x = NULL)\n```\n\n# Demographics\n\nWe create tables to determine the representativeness of the sample. We compare these again the latest available data [here](https://www.acara.edu.au/reporting/national-report-on-schooling-in-australia/staff-numbers#:~:text=Key%20Facts,schools%2018.2%25%20in%20independent%20schools.) and [here](https://www.acara.edu.au/reporting/national-report-on-schooling-in-australia/school-numbers).\n\n## Teacher characteristics\n\n```{r}\n#| label: tab-demographic-counts\n\n# create custom function\ndemographic_counts <- function(column) {\n  col_name <- sym(column)\n\n  question_name <- get_label(clean_survey[[column]])\n\n  clean_survey |> \n    count(!!col_name) |> \n    drop_na() %>%\n    mutate(\n      response = as.character(pull(., !!col_name)),\n      prop = (n / sum(n)),\n      demographic = str_extract(question_name, boundary(\"word\")) |>\n             str_to_sentence() |> str_replace_all(\"_\", \" \")) |> \n    select(demographic, response, n, prop)\n}\n\n# Read in ACARA staff data\nacara_staff_data <- read_xlsx(path = \"data/acara_staff_data.xlsx\") |> \n  clean_names() |> \n  mutate(staff_count = parse_number(staff_count)) |> \n  filter(calendar_year == 2023)\n\n# Sex\nsex_population_data <-\n  acara_staff_data |>\n  filter(\n    state_territory == \"Australia\",\n    school_sector == \"All\",\n    school_level == \"Primary\",\n    staff_function == \"Teaching staff\"\n  ) |>\n  group_by(sex_gender) |>\n  summarise(Freq = sum(staff_count)) |>\n  filter(sex_gender != \"All\")\n\nsex <- demographic_counts(\"Q4\") |>\n  left_join(\n    (sex_population_data |>\n      mutate(prop = (Freq / sum(Freq)))),\n    by = join_by(response == sex_gender)\n  ) |>\n  adorn_totals(fill = \"Total\") |>\n  select(-demographic) |> \n  rename(prop = prop.x)\n\n\n# Leadership status\n# Note that AITSL data is not restricted to primary school\nleadership_roles_population <- \n  read.csv(\"data/school_leaders_gender.csv\", skip = 1, header = T, nrows = 6) |> \n  janitor::clean_names() |> \n  select(school_leaders, x2036) |> \n  group_by(school_leaders) |> \n  summarise(Freq = sum(x2036)) |> \n  filter(school_leaders != \"School leaders\") |> \n  rename(role_in_school = school_leaders)\n\nclassroom_teachers_population <- \n  read.csv(\"data/classroom_teachers_gender.csv\", skip = 1, header = T, nrows = 6) |> \n  janitor::clean_names() |> \n  select(classroom_teachers , x2022) |> \n  filter(classroom_teachers == \"Classroom teachers\") |> \n  group_by(classroom_teachers) |> \n  summarise(Freq = sum(x2022)) |> \n  rename(role_in_school = classroom_teachers)\n\nrole_in_school_population <- \n  rbind(leadership_roles_population,\n      classroom_teachers_population)\n\nclean_survey <- \n  clean_survey |> \n  mutate(role_in_school =\n         case_when(grepl(\"principal\", Q6, ignore.case = T) ~ \"Senior leaders\",\n                   is.na(Q6) ~ \"Classroom teachers\", \n                   .default = \"Middle leaders\"))\n                   \nleadership_roles <- \n  clean_survey |> \n  separate_rows(Q6, sep = \",\") |> \n  group_by(Q6) |> \n  count() |>\n  ungroup() |> \n  mutate(prop = n/sum(n)) |> \n  replace_na(list(Q6 = \"No leadership role\")) |> \n  mutate(Q6 = str_replace(Q6, \"Other\", \"Other leadership role\")) |> \n  mutate(response = factor(Q6,\n                           levels = c(\"Principal\", \n                                      \"Deputy principal\", \n                                      \"Instructional leader\", \n                                      \"Team leader\", \n                                      \"Pastoral or wellbeing leader\", \n                                      \"Other leadership role\", \n                                      \"No leadership role\")), \n         .keep = \"unused\", \n         .before = everything()) |> \n  arrange(response) |> \n  adorn_totals(fill = \"Total\")\n\n# Main role\nrole <- demographic_counts(\"Q5\") |> \n  arrange(-n) |> \n  select(-demographic) |> \n  adorn_totals(fill = \"Total\")\n\n\n# Years of experience\n# From AITSL.\nyears_of_experience_population <- \n  read.csv(\"data/workforce_by_experience.csv\", header = T, skip = 1, nrows = 6) |> \n  janitor::clean_names() |> \n  select(years_in_profession, x2022) |> \n  rename(Freq = x2022) |>\n  mutate(new_year_categories = factor(c(\n  \"<5 years\",       # AITSL data is 1-5 years, so doesn't match our <5 years\n  \"5-9 years\",      # AITSL data is 6-9 years, so doesn't match our 5-9 years\n  \"10-20 years\",    # AITSL data is 10-19 years, so doesn't match our 10-20 years\n  \"20+ years\",      # 20-29 years (20+ is aggregated)\n  \"20+ years\",      # 30-39 years (20+ is aggregated)\n  \"20+ years\"       # 40 or more years (20+ is aggregated)\n))) |> \n  aggregate(Freq ~ new_year_categories, sum)\n\nclean_survey <- clean_survey |> \n  mutate(new_year_categories =\n         case_when(Q11 == \"<2 years\" ~ \"<5 years\", \n                   Q11 == \"2-4 years\" ~ \"<5 years\", \n                   Q11 == \"5-9 years\" ~ \"5-9 years\", \n                   Q11 == \"10-20 years\" ~ \"10-20 years\", \n                   Q11 == \">20 years\" ~ \"20+ years\") |> \n           factor(levels = c(\"<5 years\", \"5-9 years\", \"10-20 years\", \"20+ years\")))\n\nyears_of_experience <- clean_survey |>\n  count(new_year_categories) |> \n  mutate(prop = n/sum(n)) |> # May need to switch this code around, depending on response rate\n  left_join(years_of_experience_population |> \n  mutate(prop = Freq/sum(Freq)), \n  join_by(new_year_categories == new_year_categories)) |> \n  arrange(new_year_categories) |> \n  adorn_totals(fill = \"Total\") |> \n  rename(c(response = new_year_categories,\n           prop = prop.x))\n\nbind_rows(sex,\n          role, \n          leadership_roles, \n          years_of_experience) |> \n  mutate(across(starts_with(\"prop\"), percent, 1)) |> \n  kable(col.names = c(\"Response\", \"N\", \"%\", \"N\", \"%\"), \n        align = c(\"lrrrr\"), digits = 0, \n        format.args = list(big.mark = ',')) |> \n  add_header_above(c(\"Characteristic\" = 1, \"Grattan survey\" = 2, \"Population data\" = 2)) |> \n  pack_rows(\"Sex\", 1, 5, color = grattan_orange) |> \n  pack_rows(\"Main teaching role\", 6, 12, color = grattan_orange) |> \n  pack_rows(\"Leadership responsibilities*\", 13, 20, color = grattan_orange) |> \n  pack_rows(\"Years of teaching experience\", 21, 25, color = grattan_orange) |> \n  add_footnote(glue(\"Options add up to more than \", total_sample, \" because respondents could select multiple leadership responsibilities.\"), notation = \"symbol\",\n               threeparttable = T) |> \n  add_footnote(\"Note: Population data is taken from ACARA (2023) and AITSL (2023). AITSL's years of experience buckets are only an approximate match for our buckets.\", notation = \"none\")\n\n```\n\n## School characteristics\n\n```{r}\n# | label: school characteristics\n# Read in ACARA school profile dataset\n# Source: https://view.officeapps.live.com/op/view.aspx?src=https%3A%2F%2Fdataandreporting.blob.core.windows.net%2Fanrdataportal%2FData-Access-Program%2FSchool%2520Profile%25202023.xlsx&wdOrigin=BROWSELINK\n\nacara_school_data <- read_excel(\"data/acara_school_profile.xlsx\", sheet = 2) |> \n  clean_names()\n\n# School type\nschool_type_school_profile <- acara_school_data |> \n  group_by(school_type) |> \n  summarise(Freq = sum(teaching_staff, na.rm = T)) |> \n  filter(school_type %in% c(\"Primary\", \"Combined\", \"Special\"))\n\nschool_type_staff_data <- acara_staff_data |> \n  filter(state_territory == \"Australia\", \n         school_sector == \"All\", \n         sex_gender == \"All\",\n         staff_function == \"Teaching staff\") |> \n  group_by(school_level) |> \n  summarise(Freq = sum(staff_count))\n\ncombined_in_primary <- \n  (school_type_staff_data$Freq[2] - school_type_school_profile$Freq[2] - school_type_school_profile$Freq[3]/2) # Assume that half of all teachers in special schools work with primary aged kids\n\n# Determine how many of the combined and special staff work in primaries\nschool_type_australia <- \n  school_type_school_profile |> \n  mutate(Freq = case_when(\n    school_type == \"Combined\" ~ combined_in_primary,\n    school_type == \"Special\" ~ Freq/2, \n    .default = Freq)) |> \n  filter(school_type %in% c(\"Primary\", \"Combined\", \"Special\"))\n  \n\nclean_survey <- clean_survey |> \n  mutate(school_type =  case_when(\n    Q16 == \"Yes\" ~ \"Special\",\n    Q3 == \"Primary\" ~ \"Primary\", \n    Q3 == \"Combined primary and secondary\" ~ \"Combined\",\n    is.na(Q3) ~ \"Primary\" # Six responses somehow have missing values for this question, despite it being compulsory and them responding with details about their school\n  ))\n\n\nschool_type_survey <- \n  clean_survey |> \n  count(school_type) |> \n  drop_na() |> \n  mutate(prop = n/sum(n))\n\nschool_type <- left_join(school_type_survey, \n                         (school_type_australia |> \n                            mutate(prop = Freq/sum(Freq))), \n                         by = join_by(school_type == school_type)) |> \n  arrange(-n) |> \n  rename(response = school_type) |> \n  adorn_totals(fill = \"Total\")\n\nrm(school_type_school_profile, school_type_staff_data, school_type_survey)\n\n# School sector\nschool_sector_population <- \n  acara_staff_data |> \n  filter(state_territory == \"Australia\", \n         school_level == \"Primary\",\n         staff_function == \"Teaching staff\",\n         sex_gender == \"All\") |> \n  group_by(school_sector) |> \n  summarise(Freq = sum(staff_count)) |> \n  filter(school_sector != c(\"All\", \"All non-government\"))\n\nschool_sector <- left_join(\ndemographic_counts(\"Q18\"),\n  (school_sector_population |> \n  mutate(prop = Freq/sum(Freq))),\nby = join_by(response == school_sector)) |> \n  select(-demographic) |> \n  adorn_totals(fill = \"Total\")\n\n# State and territory \nstate_and_territory_population <- acara_staff_data |>\n    filter(\n      school_sector == \"All\",\n      school_level == \"Primary\",\n      staff_function == \"Teaching staff\",\n      sex_gender == \"All\"\n    ) |>\n    group_by(state_territory) |>\n    summarise(Freq = sum(staff_count)) |>\n    filter(state_territory != \"Australia\") \n\nstate_and_territory <- \n  left_join(\n  (demographic_counts(\"Q19\") |> \n  mutate(response = clean_state(response, to = \"state_name\"))),\n  (state_and_territory_population |>\n    mutate(prop = Freq / sum(Freq))),\n  by = join_by(response == state_territory)\n) |> \n  select(-demographic) |> \n  adorn_totals(fill = \"Total\")\n\n# Advantage\nses_population <- \n  acara_school_data |> \n  mutate(ses = case_when(\n    icsea_percentile <= 33.33 ~ \"Mostly disadvantaged\",\n    between(icsea_percentile, 33.33, 66.66) ~ \"A fairly even mix of advantaged and disadvantaged students\",\n    icsea_percentile >= 66.66 ~ \"Mostly advantaged\"\n  )) |> \n  group_by(ses) |> \n  summarise(Freq = sum(teaching_staff, na.rm = T)) |> \n  drop_na()\n\nses <-  \n  left_join(\n    demographic_counts(\"Q20\"),\n  (ses_population |> # Some NAs for schools without ICSEA values\n  mutate(prop = Freq/sum(Freq))),\n  by = join_by(response == ses)) |> \n  select(-demographic) |> \n  adorn_totals(fill = \"Total\")\n\n# Location\nlocation <- \n  left_join(\n    demographic_counts(\"Q21\") |> arrange(-n),\n  (\n  acara_school_data |> \n  mutate(simplified_geography = case_when(\n    geolocation == \"Major Cities\" ~ \"Metropolitan\",\n    geolocation == \"Inner Regional\" ~ \"Regional\", \n    geolocation == \"Outer Regional\" ~ \"Rural\",\n    geolocation == \"Remote\" ~ \"Remote\", \n    geolocation == \"Very Remote\" ~ \"Remote\"\n  )) |> \n  group_by(simplified_geography) |> \n  summarise(Freq = sum(teaching_staff, na.rm = T)) |> \n  mutate(prop = Freq/sum(Freq))),\n  by = join_by(response == simplified_geography)) |> \n  select(-demographic) |> \n  adorn_totals(fill = \"Total\")\n\n# School size\nschool_size_survey <- \n  clean_survey |> \n  count(Q22) |> \n  drop_na() |> \n  mutate(prop = n/sum(n))\n\nschool_size_australia <- \n  acara_school_data |> \n  # What to do about special and combined?\n  filter(school_type == \"Primary\") |> \n  mutate(size = case_when(\n     is.na(total_enrolments) ~ NA_character_, \n    total_enrolments <= 50 ~ \"Up to 50 students\",\n    total_enrolments > 50 & total_enrolments <= 100 ~ \"51 to 100 students\",\n    total_enrolments > 100 & total_enrolments <= 200 ~ \"101 to 200 students\",\n    total_enrolments > 200 & total_enrolments <= 300 ~ \"201 to 300 students\",\n    total_enrolments > 300 & total_enrolments <= 400 ~ \"301 to 400 students\",\n    total_enrolments > 400 & total_enrolments <= 500 ~ \"401 to 500 students\",\n    total_enrolments > 500 & total_enrolments <= 600 ~ \"501 to 600 students\",\n    total_enrolments > 600 & total_enrolments <= 700 ~ \"601 to 700 students\",\n    total_enrolments > 700 & total_enrolments <= 800 ~ \"701 to 800 students\",\n    total_enrolments > 800 & total_enrolments <= 900 ~ \"801 to 900 students\",\n    total_enrolments > 900 & total_enrolments <= 1000 ~ \"901 to 1000 students\",\n    total_enrolments > 1000 ~ \"More than 1,000 students\"\n  )) %>%\n  group_by(size) |> \n  summarise(Freq = sum(teaching_staff, na.rm = T)) |> \n  drop_na() |> \n  rename(school_size = size)\n\nschool_size <- \n  left_join(\n  school_size_survey, \n  (school_size_australia |> \n  mutate(prop = Freq/sum(Freq))), \n  by = join_by(Q22 == school_size)\n) |>  \n  mutate(Q22 = factor(Q22, levels = c(\n    \"Up to 50 students\",\n    \"51 to 100 students\",\n    \"101 to 200 students\",\n    \"201 to 300 students\",\n    \"301 to 400 students\",\n    \"401 to 500 students\",\n    \"501 to 600 students\",\n    \"601 to 700 students\",\n    \"701 to 800 students\",\n    \"801 to 900 students\",\n    \"901 to 1000 students\",\n    \"More than 1,000 students\"\n  ))) |> \n  arrange(Q22) |> \n  rename(response = Q22) |> \n  adorn_totals(fill = \"Total\")\n\n# Print table\n\nrbind(school_type,\n      school_sector,\n      state_and_territory,\n      ses,\n      location,\n      school_size) |> \n  mutate(across(starts_with(\"prop\"), percent, 1)) |> \n  kable(col.names = c(\"Response\", \"N\", \"%\", \"N\", \"%\"), \n        align = c(\"lrrrr\"), digits = 0, \n        format.args = list(big.mark = ',')) |> \n  add_header_above(c(\"Characteristic\" = 1, \"Grattan survey\" = 2, \"Population data\" = 2)) |> \n  pack_rows(\"Stage of schooling\", 1, 4, color = grattan_orange) |> \n  pack_rows(\"Sector\", 5, 8, color = grattan_orange) |> \n  pack_rows(\"Jursidiction\", 9, 17, color = grattan_orange) |> \n  pack_rows(\"Level of advantage or disadvantage\", 18, 21, color = grattan_orange) |> \n  pack_rows(\"Remoteness\", 22, 26, color = grattan_orange) |> \n  pack_rows(\"School size\", 27, 39, color = grattan_orange)\n\n  \n```\n\n# Weighting the responses\n\nOur survey represents a sample from the total population of teachers and principals. To reduce the biases of our estimates, we weight responses.\n\nTo weight responses, we use the same method as that employed by the Social Research Centre [-@socialresearchcentre2023].\n\nBest practice would involve a two-step process [@kalton2003weighting]. The first step is reduce biases caused by non-coverage of the population and non-response (for example, teachers not on Facebook). The second step is to align weighted sample estimates with external data about the target population.\n\nWe cannot do this first step, as we lack numerical data about the selection mechanisms which would or would not cause people to respond to our survey. The Social Research Centre [-@socialresearchcentre2023] similarly could not calculate base weights in their survey of educators.\n\nWe include the following variables in weighting:\n\n-   Gender\n\n-   Years of experience\n\n-   State and territory\n\n-   School type\n\n-   School sector\n\n-   School-level of advantage.\n\n-   School size\n\nWe cannot include the following categories:\n\n-   Role (e.g. principal, classroom teacher): AITSL's public datasets do not distinguish between primary and secondary. I have sent a data request to try get the split of leadership roles for primary schools.\n\n-   Geography: AITSL and ACARA match a school's postcode with the ABS's *Australian Statistical Geography Standard.* We asked teachers about their school's location. I am not confident enough in the concordance between perception data and matched postcode data to weight by this variable.\n\nWe had to make some transformations to the data to weight it. Namely:\n\n-   Gender: In its school staff dataset, ACARA randomly assigns people who identify as a gender other than Male or Female to one of Male or Female. We use this method too.\n\n-   School size: There were `r clean_survey |>  filter(is.na(Q22)) |>  nrow()` survey respondents who did not mention their school's size. I have imputed a school size for these respondents.\n\n```{r}\n#| label: weighting-survey\n#| output: false\n#| include: false\n\n# Function to randomly assign other genders to Male / Female, per the ABS\n\nreassign_gender <- function(gender) {\n  if (gender %in% c(\"Prefer not to say\", \"Something else\")) {\n    return(sample(c(\"Female\", \"Male\"), 1))\n  } else {\n    return(gender)\n  }\n}\n\nclean_survey$sex_gender <- sapply(clean_survey$Q4, reassign_gender)\n\n# Clean up state names\nclean_survey$state_territory <- clean_state(clean_survey$Q19, to = \"state_name\")\n\n# Fix other names\nclean_survey <- rename(clean_survey, \n       c(school_sector = Q18,\n       ses = Q20))\n\n# Impute missing school sizes\npredictor_columns <- c(\"state_territory\", \n                       \"Q3\", # school type\n                       \"school_sector\", \n                       \"ses\",\n                       \"Q21\", # rurality\n                       \"Q22\")\n\nclean_survey <- \n  clean_survey |> \n  mutate(across(c(state_territory,\n                  Q3, \n                  school_sector,\n                  ses,\n                  Q21,\n                  Q22), \n                as_factor))\n\npredictorMatrix <- make.predictorMatrix(clean_survey[,predictor_columns])\npredictorMatrix[,] <- 0\npredictorMatrix[\"Q22\", predictor_columns] <- 1\n\nsummary(clean_survey$Q22)\n\nimputation_model <- mice::mice(clean_survey[,predictor_columns], \n                             m = 5, \n                             predictorMatrix = predictorMatrix, \n                             seed = 500)\n\nimputed_data <- mice::complete(imputation_model)\n\nclean_survey$school_size <- imputed_data$Q22\n\nsummary(clean_survey$Q22)\nsummary(clean_survey$school_size)\n\n# Create survey object\nsurvey_data <- \n  clean_survey |> \n  srvyr::as_survey_design(ids = NULL)\n\n# Post-stratify on sex, experience, state, sector, and level of advantage \n# We choose not to post-stratify by geography or stage of schooling given I am not confident in the population data for these variables. \n# We also cannot rake by school size, as this question was not compulsory, so some users skipped it and raking requires so missing data. \nsurvey_data_raked <- survey::rake(\n  design = survey_data,\n  sample.margins = list(~sex_gender, \n                        ~new_year_categories, \n                        ~state_territory, \n                        ~school_type,  \n                        ~school_sector, \n                        ~ses,\n                        ~school_size),\n  population.margins = list(sex_population_data, \n                            years_of_experience_population, \n                            state_and_territory_population, \n                            school_type_australia, \n                            school_sector_population, \n                            ses_population,\n                            school_size_australia)\n)\n\nsave(survey_data_raked, file = \"data/raked_survey.Rdata\")\n```\n\nWe can visualise the distribution of weights.\n\n```{r}\ndata.frame(x = weights(survey_data_raked)) |> \n  ggplot(aes(x = x)) +\n  geom_histogram(binwidth = 10) + \n  geom_freqpoly(binwidth = 10) +\n  # theme and labels\n  theme_grattan() + \n  grattan_colour_manual() +\n  grattan_fill_manual() +\n  grattan_y_continuous(labels = comma) + \n  labs(title = \"The distribution of weights is left-skewed\",\n       subtitle = \"Distribution of person-level weights\",\n       x = \"Person-level weight\\n(approximate number of teachers in population\\nrepresented per respondent)\", y = NULL,\n       caption = glue('{source_caption}'))\n```\n\nWe can compare the results of weighting the datasets.\n\n```{r}\n# label: compare results\n\nweighted_results <- \n  survey_data_raked |>\n  drop_na(Q13) |> \n  group_by(Q13) |> \n  summarise(prop = survey_mean(na.rm = T, vartype = \"ci\", level = 0.9)) |> \n  drop_na(Q13) |> \n  mutate(method = \"Weighted\")\n\nunweighted_results <- count(clean_survey, Q13) |> \n  drop_na() |> \n  mutate(prop = n/sum(n)) |> \n  select(-n) |> \n  mutate(method = \"Unweighted\")\n\nbind_rows(weighted_results, unweighted_results) |> \n  ggplot(aes(x = factor(Q13, \n                        levels = c(\"No maths\",\n                                   \"Foundational maths\",\n                                   \"Lower intermediate maths\", \n                                   \"Upper intermediate maths\",\n                                   \"Advanced maths\")) |> fct_rev(),\n             y = prop, \n             ymin = prop_low, \n             ymax = prop_upp, \n             fill = method)) +\n  geom_col(position = \"dodge\") +\n  geom_errorbar(position = \"dodge\", \n                color = \"black\") +\n  ggdirectlabel::geom_richlegend(aes(label = fct_rev(method), \n                                     color = method), \n                                 size = 18/.pt) +\n  coord_flip() +\n  # theme and labels\n  theme_grattan(flipped = T) + \n  grattan_colour_manual(n = 2) +\n  grattan_fill_manual(n = 2) +\n  grattan_y_continuous(labels = percent) + \n  labs(title = \"Our survey's weighted results are similar to raw results,\\nbut will help us draw more reliable inferences\",\n       subtitle = \"Survey results with 90 per cent confidence intervals\",\n       y = NULL,\n       caption = glue('{source_caption}'))\n  \n```\n\nPlease note that not all the charts throughout this file have been updated with appropriate weights.\n","srcMarkdownNoYaml":"\n\n```{r}\n#| label: set-up\n#| include: false\n\nsource(\"R/globals.R\")\n\n```\n\n# Import data\n\nWe first import the data straight from Qualtrics following the instructions [here](https://api.qualtrics.com/instructions/ZG9jOjg3NjYzNQ-finding-your-qualtrics-i-ds). We also export a dated version of the survey, for file management.\n\n```{r}\n#| label: import\n#| include: false\n\n# To connect to the Qualtrics API, uncomment the following line of code the first time you run this  script, and then restart R.\n\nqualtrics_api_credentials(api_key = \"yKIwTusJkJAY9esZ4GQkqZKURN7Pq1RxI6vkvD4Q\", base_url = \"melbourneuni.au1.qualtrics.com\", install = TRUE, overwrite = TRUE)\n\nreadRenviron(\"~/.Renviron\")\n\nsurveys <- all_surveys()\n\nsurvey_id <- surveys |>\n  filter(str_detect(name, \"primary school mathematics\")) |>\n  pull(id)\n\n# Change the id below based on the id of the primary numeracy survey in your list of surveys.\nraw_survey_data <- fetch_survey(\n  surveyID = survey_id,\n  verbose = FALSE,\n  include_display_order = FALSE,\n  start_date = as.Date(\"2024-07-04\"),\n  breakout_sets = FALSE,\n  convert = FALSE\n)\n\n# Save the Qualtrics survey, just in case\ncurrentDate <- Sys.Date()\n\nfilename <- paste(\"data/survey\", currentDate, \".csv\", set = \"\")\n\n# write.csv(raw_survey_data, file = filename)\n\n# Check what data looks like\nraw_survey_data |>\n  select(matches(\"Q\\\\d+\") & !contains(c(\"DO\", \"TEXT\", \"Q6\", \"Q7\"))) |>\n  head(5) |>\n  kable() |>\n  row_spec(0:5, extra_css = \"height: 10px\")\n```\n\n# Filter to valid sample\n\nWe filter out:\n\n-   Anyone whose responses are [flagged by Qualtrics as suspicious](https://www.qualtrics.com/support/survey-platform/survey-module/survey-checker/fraud-detection/) (i.e. Q_RecaptchaScore is below 0.5). This is typically because of the speed at which they respond, or 'straight lining' (i.e. clicking the same radio buttons in a single column).\n\n-   Anyone who did not complete more than one substantive (i.e. non-demographic) question.\n\n```{r}\n#| label: clean_survey\n\ninitial_sample <- nrow(raw_survey_data)\n\nclean_survey <- raw_survey_data |>\n  filter(Q_RecaptchaScore >= 0.5) # filter out bots\n\nsubstantive_questions <- names(clean_survey)[which(names(clean_survey) == \"Q24\"):ncol(clean_survey) - 1]\n\n# Check if all values in each row from Q24 onwards are NA\nresponses_to_keep <- rowSums(is.na(clean_survey[substantive_questions])) < length(substantive_questions)\n\nclean_survey <- clean_survey[responses_to_keep, ]\n\ntotal_sample <- nrow(clean_survey)\n\n# Export survey\nsave(clean_survey, file = \"data/clean_survey.Rdata\")\n\n```\n\nThrough this process, we lose `r initial_sample - total_sample` responses. This leaves us with `r comma(total_sample)` valid responses.\n\nWe also check for duplicates, using [Qualtrics duplicate flag](https://www.qualtrics.com/support/survey-platform/survey-module/survey-checker/fraud-detection/). This pulls out respondents who try reattempt the survey from the same IP address. We can see if they are duplicates by looking through their answers manually.\n\n```{r}\n#| label: tab-check-for-duplicates\n#| caption: Extract of data from possible duplicates\n\npossible_duplicates <- clean_survey |>\n  filter(Q_BallotBoxStuffing) |>\n  select(ResponseId, IPAddress, matches(\"Q\")) |>\n  kable()\n```\n\nWe now check the number of valid responses over time, in @fig-responses-over-time.\n\n```{r}\n#| label: fig-responses-over-time\n#| fig-cap: \"Number of responses over time\"\nclean_survey |>\n  rowid_to_column() |>\n  ggplot(aes(x = RecordedDate, y = rowid)) +\n  geom_line() +\n  theme_grattan() +\n  scale_x_datetime(\n    date_labels = \"%d-%b\",\n  ) +\n  scale_y_continuous_grattan() +\n  labs(x = NULL)\n```\n\n```{r}\n#| echo: false\n#| output: false\n# Check the WA responses over time: Did the WA department actually share the survey?\nclean_survey |>\n  filter(Q19 == \"WA\") |> \n  rowid_to_column() |>\n  ggplot(aes(x = RecordedDate, y = rowid)) +\n  geom_line() +\n  geom_vline(xintercept = dmy(\"30/07/2024\")) +\n  theme_grattan() +\n  scale_x_datetime(\n    date_labels = \"%d-%b\",\n  ) +\n  scale_y_continuous_grattan() +\n  labs(x = NULL)\n```\n\n# Demographics\n\nWe create tables to determine the representativeness of the sample. We compare these again the latest available data [here](https://www.acara.edu.au/reporting/national-report-on-schooling-in-australia/staff-numbers#:~:text=Key%20Facts,schools%2018.2%25%20in%20independent%20schools.) and [here](https://www.acara.edu.au/reporting/national-report-on-schooling-in-australia/school-numbers).\n\n## Teacher characteristics\n\n```{r}\n#| label: tab-demographic-counts\n\n# create custom function\ndemographic_counts <- function(column) {\n  col_name <- sym(column)\n\n  question_name <- get_label(clean_survey[[column]])\n\n  clean_survey |> \n    count(!!col_name) |> \n    drop_na() %>%\n    mutate(\n      response = as.character(pull(., !!col_name)),\n      prop = (n / sum(n)),\n      demographic = str_extract(question_name, boundary(\"word\")) |>\n             str_to_sentence() |> str_replace_all(\"_\", \" \")) |> \n    select(demographic, response, n, prop)\n}\n\n# Read in ACARA staff data\nacara_staff_data <- read_xlsx(path = \"data/acara_staff_data.xlsx\") |> \n  clean_names() |> \n  mutate(staff_count = parse_number(staff_count)) |> \n  filter(calendar_year == 2023)\n\n# Sex\nsex_population_data <-\n  acara_staff_data |>\n  filter(\n    state_territory == \"Australia\",\n    school_sector == \"All\",\n    school_level == \"Primary\",\n    staff_function == \"Teaching staff\"\n  ) |>\n  group_by(sex_gender) |>\n  summarise(Freq = sum(staff_count)) |>\n  filter(sex_gender != \"All\")\n\nsex <- demographic_counts(\"Q4\") |>\n  left_join(\n    (sex_population_data |>\n      mutate(prop = (Freq / sum(Freq)))),\n    by = join_by(response == sex_gender)\n  ) |>\n  adorn_totals(fill = \"Total\") |>\n  select(-demographic) |> \n  rename(prop = prop.x)\n\n\n# Leadership status\n# Note that AITSL data is not restricted to primary school\nleadership_roles_population <- \n  read.csv(\"data/school_leaders_gender.csv\", skip = 1, header = T, nrows = 6) |> \n  janitor::clean_names() |> \n  select(school_leaders, x2036) |> \n  group_by(school_leaders) |> \n  summarise(Freq = sum(x2036)) |> \n  filter(school_leaders != \"School leaders\") |> \n  rename(role_in_school = school_leaders)\n\nclassroom_teachers_population <- \n  read.csv(\"data/classroom_teachers_gender.csv\", skip = 1, header = T, nrows = 6) |> \n  janitor::clean_names() |> \n  select(classroom_teachers , x2022) |> \n  filter(classroom_teachers == \"Classroom teachers\") |> \n  group_by(classroom_teachers) |> \n  summarise(Freq = sum(x2022)) |> \n  rename(role_in_school = classroom_teachers)\n\nrole_in_school_population <- \n  rbind(leadership_roles_population,\n      classroom_teachers_population)\n\nclean_survey <- \n  clean_survey |> \n  mutate(role_in_school =\n         case_when(grepl(\"principal\", Q6, ignore.case = T) ~ \"Senior leaders\",\n                   is.na(Q6) ~ \"Classroom teachers\", \n                   .default = \"Middle leaders\"))\n                   \nleadership_roles <- \n  clean_survey |> \n  separate_rows(Q6, sep = \",\") |> \n  group_by(Q6) |> \n  count() |>\n  ungroup() |> \n  mutate(prop = n/sum(n)) |> \n  replace_na(list(Q6 = \"No leadership role\")) |> \n  mutate(Q6 = str_replace(Q6, \"Other\", \"Other leadership role\")) |> \n  mutate(response = factor(Q6,\n                           levels = c(\"Principal\", \n                                      \"Deputy principal\", \n                                      \"Instructional leader\", \n                                      \"Team leader\", \n                                      \"Pastoral or wellbeing leader\", \n                                      \"Other leadership role\", \n                                      \"No leadership role\")), \n         .keep = \"unused\", \n         .before = everything()) |> \n  arrange(response) |> \n  adorn_totals(fill = \"Total\")\n\n# Main role\nrole <- demographic_counts(\"Q5\") |> \n  arrange(-n) |> \n  select(-demographic) |> \n  adorn_totals(fill = \"Total\")\n\n\n# Years of experience\n# From AITSL.\nyears_of_experience_population <- \n  read.csv(\"data/workforce_by_experience.csv\", header = T, skip = 1, nrows = 6) |> \n  janitor::clean_names() |> \n  select(years_in_profession, x2022) |> \n  rename(Freq = x2022) |>\n  mutate(new_year_categories = factor(c(\n  \"<5 years\",       # AITSL data is 1-5 years, so doesn't match our <5 years\n  \"5-9 years\",      # AITSL data is 6-9 years, so doesn't match our 5-9 years\n  \"10-20 years\",    # AITSL data is 10-19 years, so doesn't match our 10-20 years\n  \"20+ years\",      # 20-29 years (20+ is aggregated)\n  \"20+ years\",      # 30-39 years (20+ is aggregated)\n  \"20+ years\"       # 40 or more years (20+ is aggregated)\n))) |> \n  aggregate(Freq ~ new_year_categories, sum)\n\nclean_survey <- clean_survey |> \n  mutate(new_year_categories =\n         case_when(Q11 == \"<2 years\" ~ \"<5 years\", \n                   Q11 == \"2-4 years\" ~ \"<5 years\", \n                   Q11 == \"5-9 years\" ~ \"5-9 years\", \n                   Q11 == \"10-20 years\" ~ \"10-20 years\", \n                   Q11 == \">20 years\" ~ \"20+ years\") |> \n           factor(levels = c(\"<5 years\", \"5-9 years\", \"10-20 years\", \"20+ years\")))\n\nyears_of_experience <- clean_survey |>\n  count(new_year_categories) |> \n  mutate(prop = n/sum(n)) |> # May need to switch this code around, depending on response rate\n  left_join(years_of_experience_population |> \n  mutate(prop = Freq/sum(Freq)), \n  join_by(new_year_categories == new_year_categories)) |> \n  arrange(new_year_categories) |> \n  adorn_totals(fill = \"Total\") |> \n  rename(c(response = new_year_categories,\n           prop = prop.x))\n\nbind_rows(sex,\n          role, \n          leadership_roles, \n          years_of_experience) |> \n  mutate(across(starts_with(\"prop\"), percent, 1)) |> \n  kable(col.names = c(\"Response\", \"N\", \"%\", \"N\", \"%\"), \n        align = c(\"lrrrr\"), digits = 0, \n        format.args = list(big.mark = ',')) |> \n  add_header_above(c(\"Characteristic\" = 1, \"Grattan survey\" = 2, \"Population data\" = 2)) |> \n  pack_rows(\"Sex\", 1, 5, color = grattan_orange) |> \n  pack_rows(\"Main teaching role\", 6, 12, color = grattan_orange) |> \n  pack_rows(\"Leadership responsibilities*\", 13, 20, color = grattan_orange) |> \n  pack_rows(\"Years of teaching experience\", 21, 25, color = grattan_orange) |> \n  add_footnote(glue(\"Options add up to more than \", total_sample, \" because respondents could select multiple leadership responsibilities.\"), notation = \"symbol\",\n               threeparttable = T) |> \n  add_footnote(\"Note: Population data is taken from ACARA (2023) and AITSL (2023). AITSL's years of experience buckets are only an approximate match for our buckets.\", notation = \"none\")\n\n```\n\n## School characteristics\n\n```{r}\n# | label: school characteristics\n# Read in ACARA school profile dataset\n# Source: https://view.officeapps.live.com/op/view.aspx?src=https%3A%2F%2Fdataandreporting.blob.core.windows.net%2Fanrdataportal%2FData-Access-Program%2FSchool%2520Profile%25202023.xlsx&wdOrigin=BROWSELINK\n\nacara_school_data <- read_excel(\"data/acara_school_profile.xlsx\", sheet = 2) |> \n  clean_names()\n\n# School type\nschool_type_school_profile <- acara_school_data |> \n  group_by(school_type) |> \n  summarise(Freq = sum(teaching_staff, na.rm = T)) |> \n  filter(school_type %in% c(\"Primary\", \"Combined\", \"Special\"))\n\nschool_type_staff_data <- acara_staff_data |> \n  filter(state_territory == \"Australia\", \n         school_sector == \"All\", \n         sex_gender == \"All\",\n         staff_function == \"Teaching staff\") |> \n  group_by(school_level) |> \n  summarise(Freq = sum(staff_count))\n\ncombined_in_primary <- \n  (school_type_staff_data$Freq[2] - school_type_school_profile$Freq[2] - school_type_school_profile$Freq[3]/2) # Assume that half of all teachers in special schools work with primary aged kids\n\n# Determine how many of the combined and special staff work in primaries\nschool_type_australia <- \n  school_type_school_profile |> \n  mutate(Freq = case_when(\n    school_type == \"Combined\" ~ combined_in_primary,\n    school_type == \"Special\" ~ Freq/2, \n    .default = Freq)) |> \n  filter(school_type %in% c(\"Primary\", \"Combined\", \"Special\"))\n  \n\nclean_survey <- clean_survey |> \n  mutate(school_type =  case_when(\n    Q16 == \"Yes\" ~ \"Special\",\n    Q3 == \"Primary\" ~ \"Primary\", \n    Q3 == \"Combined primary and secondary\" ~ \"Combined\",\n    is.na(Q3) ~ \"Primary\" # Six responses somehow have missing values for this question, despite it being compulsory and them responding with details about their school\n  ))\n\n\nschool_type_survey <- \n  clean_survey |> \n  count(school_type) |> \n  drop_na() |> \n  mutate(prop = n/sum(n))\n\nschool_type <- left_join(school_type_survey, \n                         (school_type_australia |> \n                            mutate(prop = Freq/sum(Freq))), \n                         by = join_by(school_type == school_type)) |> \n  arrange(-n) |> \n  rename(response = school_type) |> \n  adorn_totals(fill = \"Total\")\n\nrm(school_type_school_profile, school_type_staff_data, school_type_survey)\n\n# School sector\nschool_sector_population <- \n  acara_staff_data |> \n  filter(state_territory == \"Australia\", \n         school_level == \"Primary\",\n         staff_function == \"Teaching staff\",\n         sex_gender == \"All\") |> \n  group_by(school_sector) |> \n  summarise(Freq = sum(staff_count)) |> \n  filter(school_sector != c(\"All\", \"All non-government\"))\n\nschool_sector <- left_join(\ndemographic_counts(\"Q18\"),\n  (school_sector_population |> \n  mutate(prop = Freq/sum(Freq))),\nby = join_by(response == school_sector)) |> \n  select(-demographic) |> \n  adorn_totals(fill = \"Total\")\n\n# State and territory \nstate_and_territory_population <- acara_staff_data |>\n    filter(\n      school_sector == \"All\",\n      school_level == \"Primary\",\n      staff_function == \"Teaching staff\",\n      sex_gender == \"All\"\n    ) |>\n    group_by(state_territory) |>\n    summarise(Freq = sum(staff_count)) |>\n    filter(state_territory != \"Australia\") \n\nstate_and_territory <- \n  left_join(\n  (demographic_counts(\"Q19\") |> \n  mutate(response = clean_state(response, to = \"state_name\"))),\n  (state_and_territory_population |>\n    mutate(prop = Freq / sum(Freq))),\n  by = join_by(response == state_territory)\n) |> \n  select(-demographic) |> \n  adorn_totals(fill = \"Total\")\n\n# Advantage\nses_population <- \n  acara_school_data |> \n  mutate(ses = case_when(\n    icsea_percentile <= 33.33 ~ \"Mostly disadvantaged\",\n    between(icsea_percentile, 33.33, 66.66) ~ \"A fairly even mix of advantaged and disadvantaged students\",\n    icsea_percentile >= 66.66 ~ \"Mostly advantaged\"\n  )) |> \n  group_by(ses) |> \n  summarise(Freq = sum(teaching_staff, na.rm = T)) |> \n  drop_na()\n\nses <-  \n  left_join(\n    demographic_counts(\"Q20\"),\n  (ses_population |> # Some NAs for schools without ICSEA values\n  mutate(prop = Freq/sum(Freq))),\n  by = join_by(response == ses)) |> \n  select(-demographic) |> \n  adorn_totals(fill = \"Total\")\n\n# Location\nlocation <- \n  left_join(\n    demographic_counts(\"Q21\") |> arrange(-n),\n  (\n  acara_school_data |> \n  mutate(simplified_geography = case_when(\n    geolocation == \"Major Cities\" ~ \"Metropolitan\",\n    geolocation == \"Inner Regional\" ~ \"Regional\", \n    geolocation == \"Outer Regional\" ~ \"Rural\",\n    geolocation == \"Remote\" ~ \"Remote\", \n    geolocation == \"Very Remote\" ~ \"Remote\"\n  )) |> \n  group_by(simplified_geography) |> \n  summarise(Freq = sum(teaching_staff, na.rm = T)) |> \n  mutate(prop = Freq/sum(Freq))),\n  by = join_by(response == simplified_geography)) |> \n  select(-demographic) |> \n  adorn_totals(fill = \"Total\")\n\n# School size\nschool_size_survey <- \n  clean_survey |> \n  count(Q22) |> \n  drop_na() |> \n  mutate(prop = n/sum(n))\n\nschool_size_australia <- \n  acara_school_data |> \n  # What to do about special and combined?\n  filter(school_type == \"Primary\") |> \n  mutate(size = case_when(\n     is.na(total_enrolments) ~ NA_character_, \n    total_enrolments <= 50 ~ \"Up to 50 students\",\n    total_enrolments > 50 & total_enrolments <= 100 ~ \"51 to 100 students\",\n    total_enrolments > 100 & total_enrolments <= 200 ~ \"101 to 200 students\",\n    total_enrolments > 200 & total_enrolments <= 300 ~ \"201 to 300 students\",\n    total_enrolments > 300 & total_enrolments <= 400 ~ \"301 to 400 students\",\n    total_enrolments > 400 & total_enrolments <= 500 ~ \"401 to 500 students\",\n    total_enrolments > 500 & total_enrolments <= 600 ~ \"501 to 600 students\",\n    total_enrolments > 600 & total_enrolments <= 700 ~ \"601 to 700 students\",\n    total_enrolments > 700 & total_enrolments <= 800 ~ \"701 to 800 students\",\n    total_enrolments > 800 & total_enrolments <= 900 ~ \"801 to 900 students\",\n    total_enrolments > 900 & total_enrolments <= 1000 ~ \"901 to 1000 students\",\n    total_enrolments > 1000 ~ \"More than 1,000 students\"\n  )) %>%\n  group_by(size) |> \n  summarise(Freq = sum(teaching_staff, na.rm = T)) |> \n  drop_na() |> \n  rename(school_size = size)\n\nschool_size <- \n  left_join(\n  school_size_survey, \n  (school_size_australia |> \n  mutate(prop = Freq/sum(Freq))), \n  by = join_by(Q22 == school_size)\n) |>  \n  mutate(Q22 = factor(Q22, levels = c(\n    \"Up to 50 students\",\n    \"51 to 100 students\",\n    \"101 to 200 students\",\n    \"201 to 300 students\",\n    \"301 to 400 students\",\n    \"401 to 500 students\",\n    \"501 to 600 students\",\n    \"601 to 700 students\",\n    \"701 to 800 students\",\n    \"801 to 900 students\",\n    \"901 to 1000 students\",\n    \"More than 1,000 students\"\n  ))) |> \n  arrange(Q22) |> \n  rename(response = Q22) |> \n  adorn_totals(fill = \"Total\")\n\n# Print table\n\nrbind(school_type,\n      school_sector,\n      state_and_territory,\n      ses,\n      location,\n      school_size) |> \n  mutate(across(starts_with(\"prop\"), percent, 1)) |> \n  kable(col.names = c(\"Response\", \"N\", \"%\", \"N\", \"%\"), \n        align = c(\"lrrrr\"), digits = 0, \n        format.args = list(big.mark = ',')) |> \n  add_header_above(c(\"Characteristic\" = 1, \"Grattan survey\" = 2, \"Population data\" = 2)) |> \n  pack_rows(\"Stage of schooling\", 1, 4, color = grattan_orange) |> \n  pack_rows(\"Sector\", 5, 8, color = grattan_orange) |> \n  pack_rows(\"Jursidiction\", 9, 17, color = grattan_orange) |> \n  pack_rows(\"Level of advantage or disadvantage\", 18, 21, color = grattan_orange) |> \n  pack_rows(\"Remoteness\", 22, 26, color = grattan_orange) |> \n  pack_rows(\"School size\", 27, 39, color = grattan_orange)\n\n  \n```\n\n# Weighting the responses\n\nOur survey represents a sample from the total population of teachers and principals. To reduce the biases of our estimates, we weight responses.\n\nTo weight responses, we use the same method as that employed by the Social Research Centre [-@socialresearchcentre2023].\n\nBest practice would involve a two-step process [@kalton2003weighting]. The first step is reduce biases caused by non-coverage of the population and non-response (for example, teachers not on Facebook). The second step is to align weighted sample estimates with external data about the target population.\n\nWe cannot do this first step, as we lack numerical data about the selection mechanisms which would or would not cause people to respond to our survey. The Social Research Centre [-@socialresearchcentre2023] similarly could not calculate base weights in their survey of educators.\n\nWe include the following variables in weighting:\n\n-   Gender\n\n-   Years of experience\n\n-   State and territory\n\n-   School type\n\n-   School sector\n\n-   School-level of advantage.\n\n-   School size\n\nWe cannot include the following categories:\n\n-   Role (e.g. principal, classroom teacher): AITSL's public datasets do not distinguish between primary and secondary. I have sent a data request to try get the split of leadership roles for primary schools.\n\n-   Geography: AITSL and ACARA match a school's postcode with the ABS's *Australian Statistical Geography Standard.* We asked teachers about their school's location. I am not confident enough in the concordance between perception data and matched postcode data to weight by this variable.\n\nWe had to make some transformations to the data to weight it. Namely:\n\n-   Gender: In its school staff dataset, ACARA randomly assigns people who identify as a gender other than Male or Female to one of Male or Female. We use this method too.\n\n-   School size: There were `r clean_survey |>  filter(is.na(Q22)) |>  nrow()` survey respondents who did not mention their school's size. I have imputed a school size for these respondents.\n\n```{r}\n#| label: weighting-survey\n#| output: false\n#| include: false\n\n# Function to randomly assign other genders to Male / Female, per the ABS\n\nreassign_gender <- function(gender) {\n  if (gender %in% c(\"Prefer not to say\", \"Something else\")) {\n    return(sample(c(\"Female\", \"Male\"), 1))\n  } else {\n    return(gender)\n  }\n}\n\nclean_survey$sex_gender <- sapply(clean_survey$Q4, reassign_gender)\n\n# Clean up state names\nclean_survey$state_territory <- clean_state(clean_survey$Q19, to = \"state_name\")\n\n# Fix other names\nclean_survey <- rename(clean_survey, \n       c(school_sector = Q18,\n       ses = Q20))\n\n# Impute missing school sizes\npredictor_columns <- c(\"state_territory\", \n                       \"Q3\", # school type\n                       \"school_sector\", \n                       \"ses\",\n                       \"Q21\", # rurality\n                       \"Q22\")\n\nclean_survey <- \n  clean_survey |> \n  mutate(across(c(state_territory,\n                  Q3, \n                  school_sector,\n                  ses,\n                  Q21,\n                  Q22), \n                as_factor))\n\npredictorMatrix <- make.predictorMatrix(clean_survey[,predictor_columns])\npredictorMatrix[,] <- 0\npredictorMatrix[\"Q22\", predictor_columns] <- 1\n\nsummary(clean_survey$Q22)\n\nimputation_model <- mice::mice(clean_survey[,predictor_columns], \n                             m = 5, \n                             predictorMatrix = predictorMatrix, \n                             seed = 500)\n\nimputed_data <- mice::complete(imputation_model)\n\nclean_survey$school_size <- imputed_data$Q22\n\nsummary(clean_survey$Q22)\nsummary(clean_survey$school_size)\n\n# Create survey object\nsurvey_data <- \n  clean_survey |> \n  srvyr::as_survey_design(ids = NULL)\n\n# Post-stratify on sex, experience, state, sector, and level of advantage \n# We choose not to post-stratify by geography or stage of schooling given I am not confident in the population data for these variables. \n# We also cannot rake by school size, as this question was not compulsory, so some users skipped it and raking requires so missing data. \nsurvey_data_raked <- survey::rake(\n  design = survey_data,\n  sample.margins = list(~sex_gender, \n                        ~new_year_categories, \n                        ~state_territory, \n                        ~school_type,  \n                        ~school_sector, \n                        ~ses,\n                        ~school_size),\n  population.margins = list(sex_population_data, \n                            years_of_experience_population, \n                            state_and_territory_population, \n                            school_type_australia, \n                            school_sector_population, \n                            ses_population,\n                            school_size_australia)\n)\n\nsave(survey_data_raked, file = \"data/raked_survey.Rdata\")\n```\n\nWe can visualise the distribution of weights.\n\n```{r}\ndata.frame(x = weights(survey_data_raked)) |> \n  ggplot(aes(x = x)) +\n  geom_histogram(binwidth = 10) + \n  geom_freqpoly(binwidth = 10) +\n  # theme and labels\n  theme_grattan() + \n  grattan_colour_manual() +\n  grattan_fill_manual() +\n  grattan_y_continuous(labels = comma) + \n  labs(title = \"The distribution of weights is left-skewed\",\n       subtitle = \"Distribution of person-level weights\",\n       x = \"Person-level weight\\n(approximate number of teachers in population\\nrepresented per respondent)\", y = NULL,\n       caption = glue('{source_caption}'))\n```\n\nWe can compare the results of weighting the datasets.\n\n```{r}\n# label: compare results\n\nweighted_results <- \n  survey_data_raked |>\n  drop_na(Q13) |> \n  group_by(Q13) |> \n  summarise(prop = survey_mean(na.rm = T, vartype = \"ci\", level = 0.9)) |> \n  drop_na(Q13) |> \n  mutate(method = \"Weighted\")\n\nunweighted_results <- count(clean_survey, Q13) |> \n  drop_na() |> \n  mutate(prop = n/sum(n)) |> \n  select(-n) |> \n  mutate(method = \"Unweighted\")\n\nbind_rows(weighted_results, unweighted_results) |> \n  ggplot(aes(x = factor(Q13, \n                        levels = c(\"No maths\",\n                                   \"Foundational maths\",\n                                   \"Lower intermediate maths\", \n                                   \"Upper intermediate maths\",\n                                   \"Advanced maths\")) |> fct_rev(),\n             y = prop, \n             ymin = prop_low, \n             ymax = prop_upp, \n             fill = method)) +\n  geom_col(position = \"dodge\") +\n  geom_errorbar(position = \"dodge\", \n                color = \"black\") +\n  ggdirectlabel::geom_richlegend(aes(label = fct_rev(method), \n                                     color = method), \n                                 size = 18/.pt) +\n  coord_flip() +\n  # theme and labels\n  theme_grattan(flipped = T) + \n  grattan_colour_manual(n = 2) +\n  grattan_fill_manual(n = 2) +\n  grattan_y_continuous(labels = percent) + \n  labs(title = \"Our survey's weighted results are similar to raw results,\\nbut will help us draw more reliable inferences\",\n       subtitle = \"Survey results with 90 per cent confidence intervals\",\n       y = NULL,\n       caption = glue('{source_caption}'))\n  \n```\n\nPlease note that not all the charts throughout this file have been updated with appropriate weights.\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":[".formatting/grattan-style.css"],"toc":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.553","title":"Making it count: Improving primary school maths","subtitle":"Analysis of Grattan Institute's survey of primary school teachers","date":"7 July 2024","author":"Nick Parkinson","editor_options":{"chunk_output_type":"console"},"bibliography":["references.bib"],"highlight":"pygments","toc_depth":2,"number_sections":"yes","df_print":"kable","fig-cap-location":"top"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}
---
title: "LSAY_EDA"
format: 
  html: 
    toc: true
    toc_float: true
    toc_depth: 3
editor: visual
---

```{r warnings=FALSE, message=FALSE}
library(haven)
library(tidyverse)
library(dplyr)
library(survey)
library(intsvy)
library(kableExtra)
library(Rrepest)
library(ggplot2)
library(tidyverse)
library(grattantheme)
library(ggrepel)
library(scales)

LSAY2003 <- read_dta("data/lsay_data/au.edu.anu.ada.ddi.01111_v7.1_unrestricted.dta")


```

## Y03

### How many primary school teachers are in the data set?

To explore this in the Y03 data, we will look for the ASCED code 070103 (Teacher Education: Primary) in variables relating to questions focused at main area of study/training in this course at any given year: LBCZ087, LCCZ087, LDCZ087, LEC087, LFC087, LGC087, LHC087, LIC087, LJC088, LKC088

```{r}

UNIQUE_STUDYING_TEACHERS <- LSAY2003 %>%
  # selecting variables for current area of study
  select(STIDSTD, LBCZ087, LCCZ087, LDCZ087, LEC087, LFC087, LGC087, LHC087, LIC087, LJC088, LKC088) %>%
  # Mutate across the observation to replace 0 = not '70103', 1 = is '70103', NA values retained
  mutate(across(c(LBCZ087, LCCZ087, LDCZ087, LEC087, LFC087, LGC087, LHC087, LIC087, LJC088, LKC088),
                ~ case_when(
                   as.character(.) == '70103' ~ 1,  # PSE as 1
                   is.na(.) ~ NA_integer_, # Retain NA
                   TRUE ~ 0  # All else as 0
                 ))) %>%
  # Create new column where any 1 in the row = TRUE, no 1 = FALSE
  mutate(TEACHERS = if_any(c(LBCZ087, LCCZ087, LDCZ087, LEC087, LFC087, LGC087, LHC087, LIC087, LJC088, LKC088), ~ . == 1)) %>%
  # Keep TRUE values
  filter(TEACHERS)

# Creating table to display results
 UNIQUE_STUDYING_TEACHERS_Y03 <- kbl(UNIQUE_STUDYING_TEACHERS, caption = "Count of Primary School Education Students in Y03 Data.") %>%
  kable_paper() %>%
  row_spec(0, background = "orange", bold = TRUE) %>%
  scroll_box(width = "1200px", height = "400px")

UNIQUE_STUDYING_TEACHERS_Y03
```

There were **`r nrow(UNIQUE_STUDYING_TEACHERS)`** people studying primary school teaching at some point in the Y03 data.

```{r}
# Deeper look at  student ID 2659 and 9362
# Looking at variable LHC087 (Main area of study: 2010) as both individuals observations were 0 here.
closer_look <- LSAY2003 %>% 
  filter(STIDSTD %in% c(2659, 10049)) %>% 
  select(STIDSTD, LDCZ087, LHC087) %>%
  mutate(NEW_COURSE = c("Business Management", "Human Movement"))

kbl(closer_look, caption = "Closer look at students who left teaching.") %>%
  kable_paper() %>%
  row_spec(0, background = "orange", bold = TRUE) %>%
  scroll_box(width = "945px", height = "200px")

```

-   Student 2659 went into another field of study four years after: Business management (80301)

-   Student 10049 went into another field of study four years after: Human Movement (69903)

## How many people were working as a primary school teacher at any point of responding to the questions?

To see how many people were working as a primary school teacher at any point of responding to the questions, we focused on finding the ANSZVO code 2412 in variables related to the question:

"What kind of work do you do?" (LDD025, LED025, LFD025, LGD025, LHD029, LID029, LJD029, LKD029).

```{r}
# Seeing the amount of people who were primary school teachers at some point

UNIQUE_TEACHERS_Y03 <- LSAY2003 %>%
  # Selecting variables related to question: 'What kind of work do you do?'
  select(STIDSTD, LDD025, LED025, LFD025, LGD025, LHD029, LID029, LJD029, LKD029) %>%
  # Converting to character
  mutate(across(c(LDD025, LED025, LFD025, LGD025, LHD029, LID029, LJD029, LKD029), as.character)) %>%
  # Mutate across the observation 0 = not teacher, 1 = teacher, NA = NA. 
  mutate(across(c(LDD025, LED025, LFD025, LGD025, LHD029, LID029, LJD029, LKD029), ~ case_when(
    . == '2412' ~ 1, # Teacher = 1
    is.na(.) ~ NA_integer_, # NA values retained
    TRUE ~ 0 # Non-teacher = 0.
  ))) %>%
  # New column where 1 across row = TRUE(Teacher), all else = FALSE 
  mutate(legit_teachers = if_any(c(LDD025, LED025, LFD025, LGD025, LHD029, LID029, LJD029, LKD029), ~ . == 1)) %>%
  filter(legit_teachers) # Filtering for TRUE condition

# Creating table to display results
 UNIQUE_TEACHERS_Y03_table <- kbl(UNIQUE_TEACHERS_Y03, caption = "Number of Teachers in the Y03 Data.") %>%
  kable_paper() %>%
  row_spec(0, background = "orange", bold = TRUE) %>%
  scroll_box(width = "1200px", height = "400px")

```

```{r}
# Getting the IDs of the teachers
teacher_ids_y03 <- UNIQUE_TEACHERS_Y03$STIDSTD
```

## What did these people study?

```{r}
# Selecting IDs of previously identified Y03 Teachers
teacher_jobs <- LSAY2003[LSAY2003$STIDSTD %in% UNIQUE_TEACHERS_Y03$STIDSTD, ]

# Using those IDs and selecting area of study variables across given years
selected_columns <- c('STIDSTD', 'LBCZ087', 'LCCZ087', 'LDCZ087', 'LEC087', 'LFC087', 'LGC087', 'LHC087', 'LIC087', 'LJC088', 'LKC088')
teacher_jobs <- teacher_jobs[, selected_columns]

```

```{r}
# Creating a table for what these individuals studied
fields <- data.frame(
  Codes = c(70101, 70103, 70109, 70199, 70115, 90503, 91703, 92101, 100101, 80101),
  `Field_of_Education` = c(
    "Teacher Education: Early Childhood",
    "Teacher Education: Primary",
    "Teacher Education: Vocational Education and Training",
    "Teacher Education, n.e.c.",
    "English as a Second Language Teaching",
    "Children's Services", 
    "Religious Studies", 
    "Sport and Recreation Activities",
    "Music", "Accounting"
  )
)

# Creating a table
 fields <- kbl(fields, caption = "Area of Study for Teachers in Y03.") %>%
  kable_paper() %>%
  row_spec(0, background = "orange", bold = TRUE) %>%
  scroll_box(width = "1000px", height = "300px")
fields

```

# Understanding how many school leavers enrol in primary school teaching courses

```{r}
# Taking the IDs of individuals who had enrolled in primary school teaching at some point
studying_teachers <- unique(UNIQUE_STUDYING_TEACHERS$STIDSTD)
# Filter the LSAY2003 data for those IDs and high school leaving variables.
studying_teachers_y12 <- LSAY2003 %>% 
  filter(STIDSTD %in% studying_teachers) %>% 
  select(STIDSTD, LBWDV01, LCWDV01, LEWDV01, LIWDV01) %>%
   mutate(Studying_Teacher = rowSums(select(., LBWDV01, LCWDV01, LEWDV01, LIWDV01) == 1, na.rm = TRUE) > 0)

```

Only two of those studying primary school teaching in 2003 LSAY were school leavers. However both seemed to have return back to school to complete.

2999 & 10049 (leavers)

```{r}
# Closer look at the school leavers (year and level)
school_leavers_year_level <- LSAY2003 %>% 
  filter(STIDSTD %in% c(2999, 10049)) %>% 
  select(STIDSTD, LBB001, LCB001, LDB001, LEB001, LEA005, LFB001, LFA006)
school_leavers_year_level
```

Both left in year 11.

```{r}
school_leavers_year <- LSAY2003 %>% 
  filter(STIDSTD %in% c(2999, 10049)) %>% 
  # Selecting variables related to, "In which month and year did you leave school?"
  select(STIDSTD, LBA002B, LCA002B, LDA002B, LEA002B, LFA002Y)
school_leavers_year
```

**2999 LEFT IN 2003, 10049 LEFT IN 2004.**

-   2999 left in 2003 then went back to complete year 12 in 2005

-   10049 left in 2004 and then went back to complete year 12 in 2005.

# PISA PVs

-   Determine the percentage of primary teachers in the sample below the National proficient standard

-   Determine the average achievement of primary teachers in the sample (in PISA points)

```{r}
# understanding PVs (exploratory understanding)
# using intsvy package to calculate average scores for each state
library(intsvy)
pisa_state <- pisa.mean.pv(pvlabel = paste0("PV", 1:5, "MATH"), by = "STATEID", data = LSAY2003) %>%
  mutate(STATE = c("ACT", "NSW", "VIC", "QLD", "SA", "WA", "TAS", "NT"), .before = everything()) |> 
  select(-STATEID)

 pisa_state <- kbl(pisa_state, caption = "Average Math Performance Across States") %>%
  kable_paper() %>%
  row_spec(0, background = "orange", bold = TRUE) %>%
  scroll_box(width = "1000px", height = "300px")
pisa_state
```

"In mathematical literacy, the average performance of students in the Australian Capital Territory was significantly higher than the average achieved by students in New South Wales, Queensland, Victoria, Tasmania and the Northern Territory, and students from the Australian Capital Territory, Western Australia, South Australia, New South Wales and Queensland attained a higher average score than students in the Northern Territory. However, the performance of students in Victoria and Tasmania was not significantly different from the performance of students in the Northern Territory. These differences are more pronounced than those in maths in PISA 2000, perhaps because this measure of mathematical literacy is better defined, being the focus of [PISA 2003."](https://www.acer.org/files/PISA_screen.pdf)

Testing concordance of results using the *Rrepest* package. Note that this will take quite some time as it has to compute lots of replicates.

```{r}
LSAY2003_teachflag <- 
  LSAY2003 |> 
  mutate(teacher = if_else(STIDSTD %in% teacher_ids_y03, T, F))

Rrepest::Rrepest(data = LSAY2003_teachflag,
        svy = "PISA",
        est = est(c("mean","std"),"pv@math"),
        by = c("teacher"),
        cm.weights = c(paste0("w_fstr",1:80)),
        tabl = T)

```

Seems as though the level 3 proficiency levels for mathematics literacy is 482 in later years as well. \* [2018](https://nces.ed.gov/surveys/pisa/pisa2018/pdf/MathProfLevelDescriptionV2.pdf) \* [2022](https://nces.ed.gov/surveys/pisa/pisa2022/docs/DescriptionsOf2022ProficiencyLevels-TableI31.pdf)

```{r}
LSAY2003_proficiency <- 
  LSAY2003_teachflag |> 
  mutate(across(PV1MATH:PV5MATH,
                ~ if_else(. >= 482, "Proficient", "Not proficient", missing = NA_character_),
                .names = "{col}proficient"))

Rrepest::Rrepest(data = LSAY2003_proficiency,
        svy = "PISA",
        est = est("freq","pv@mathproficient"),
        by = "teacher",
        cm.weights = c(paste0("w_fstr",1:80)), # Our replicate weights have different names to those in PISA 2015 
        tabl = T)

```

## Y06 LSAY

```{r}
LSAY2006 <- read_dta("data/lsay_data/au.edu.anu.ada.ddi.01137_v10.1_unrestricted.dta")
```

```{r}
# 2006 COHORT - exploring those who studied primary school teaching
STUDYING_TEACHERS_2006 <- LSAY2006 %>%
  # selecting variables for current area of study
  select(STIDSTD, LBC087, LCC087, LDC087, LEC087, LFC087, LGC088, LHC088, LIC088, LJC088, LKC088) %>%
  # Mutate across the observation to replace 0 = not '70103', 1 = is '70103'
  mutate(across(c(LBC087, LCC087, LDC087, LEC087, LFC087, LGC088, LHC088, LIC088, LJC088, LKC088),
                ~ case_when(
                   as.character(.) == '70103' ~ 1,  # PSE as 1
                   is.na(.) ~ NA_integer_, # Retain NA
                   TRUE ~ 0  # All else as 0
                 ))) %>%
  # Create new column where any 1 in the row = TRUE, no 1 = FALSE
  mutate(unique_teachers = if_any(c(LBC087, LCC087, LDC087, LEC087, LFC087, LGC088, LHC088, LIC088, LJC088, LKC088), ~ . == 1)) %>%
  # Keep TRUE values
  filter(unique_teachers)

STUDYING_TEACHERS_2006
```

```{r}
# Looking at people who were at the time working as PS Teachers

LEGIT_TEACHERS_2006 <- LSAY2006 %>%
  # Selecting variables for kind of work
  select(STIDSTD, LBD011, LCD024, LDD024, LED029, LFD029, LGD029, LHD029, LID029, LJD029, LKD029) %>%
  # Mutate across the observation 
  mutate(across(c(LBD011, LCD024, LDD024, LED029, LFD029, LGD029, LHD029, LID029, LJD029, LKD029),
                ~ case_when(
                   as.character(.) == '2412' ~ 1,  # PSE as 1
                   is.na(.) ~ NA_integer_,
                   TRUE ~ 0  # All else as 0
                 ))) %>%
  # column for TRUE = legit teachers, FALSE = not teachers
  mutate(legit_teachers = if_any(c(LBD011, LCD024, LDD024, LED029, LFD029, LGD029, LHD029, LID029, LJD029, LKD029), ~ . == 1)) %>%
  # Filter for TRUE condition
  filter(legit_teachers)

```

```{r}
# Taking a look at Y06 Teachers Area of Study
teacher_jobs_06 <- LSAY2006[LSAY2006$STIDSTD %in% LEGIT_TEACHERS_2006$STIDSTD, ]

# Selecting teacher student IDs and variables related to area of study across the years
selected_columns <- c('STIDSTD', 'LBC087', 'LCC087', 'LDC087', 'LEC087', 'LFC087', 'LGC088', 'LHC088', 'LIC088', 'LJC088', 'LKC088')
teacher_jobs_06 <- teacher_jobs_06[, selected_columns]
```

```{r}
# Creating a table to see what the teachers studied.
aos_2006 <- data.frame(
  Code = c(100705, 100103, 100101, 80399, 70103, 70101, 70105, 70199, 91701, 60901, 61399, 60101, 91703, 80101, 81101, 91523, 90513),
  Field = c(
    "Written Communication",
    "Drama and Theatre Studies",
    "Music",
    "Business and Management, n.e.c.",
    "Teacher Education: Primary",
    "Teacher Education: Early Childhood",
    "Teacher Education: Secondary",
    "Teacher Education, n.e.c.",
    "Philosophy",
    "Optometry",
    "Public Health, n.e.c.",
    "General Medicine",
    "Religious Studies",
    "Accounting",
    "Banking and Finance",
    "Literature",
    "Counselling"
  )
)
aos_2006 <- kable(aos_2006, caption = "Field of Education Codes 2006", align = "c", booktabs = TRUE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  row_spec(0, background = "orange", bold = TRUE, color = "white") %>%
  column_spec(1, bold = TRUE)

aos_2006


```

```{r}
studying_teachers_06 <- unique(LEGIT_TEACHERS_2006$STIDSTD)


# filter the LSAY2003 data for those IDs and high school leaving variables.
school_leavers_06 <- LSAY2006 %>% 
  filter(STIDSTD %in% studying_teachers_06) %>% 
  select(STIDSTD, LBWDV01, LCWDV01, LDWDV01, LEWDV01, LFWDV01) %>%
   mutate(Studying_Teacher = rowSums(select(., LBWDV01, LCWDV01, LDWDV01, LEWDV01, LFWDV01) == 1, na.rm = TRUE) > 0)
```

# PISA PVs

-   Determine the percentage of primary teachers in the sample below the National proficient standard

-   Determine the average achievement of primary teachers in the sample (in PISA points)

```{r}
teacher_ids_2006 <- LEGIT_TEACHERS_2006$STIDSTD
LSAY2006_teachflag <- 
  LSAY2006 |> 
  mutate(teacher = if_else(STIDSTD %in% teacher_ids_2006, T, F))

Rrepest::Rrepest(data = LSAY2006_teachflag,
        svy = "PISA",
        est = est(c("mean","std"),"pv@math"),
        by = c("teacher"),
        cm.weights = c(paste0("w_fstr",1:80)),
        tabl = T)

```

```{r}
LSAY2006_proficiency <- 
  LSAY2006_teachflag |> 
  mutate(across(PV1MATH:PV5MATH,
                ~ if_else(. >= 482, "Proficient", "Not proficient", missing = NA_character_),
                .names = "{col}proficient"))

Rrepest::Rrepest(data = LSAY2006_proficiency,
        svy = "PISA",
        est = est("freq","pv@mathproficient"),
        by = "teacher",
        cm.weights = c(paste0("w_fstr",1:80)), 
        tabl = T)

```

# LSAY 2009

```{r}
# reading in 2009 data
LSAY2009 <- read_dta("data/lsay_data/au.edu.anu.ada.ddi.30023v9_unrestricted.dta")

```

```{r}
# 2009 COHORT - exploring those who studied primary school teaching
STUDYING_TEACHERS_2009 <- LSAY2009 %>%
  # selecting variables for current area of study
  select(STIDSTD, LBC089, LCC088, LDC088, LEC088, LFC088, LGC088, LHC088, LIC088, LJC088, LKC088) %>%
  # Mutate across the observation to replace 0 = not '70103', 1 = is '70103'
  mutate(across(c(LBC089, LCC088, LDC088, LEC088, LFC088, LGC088, LHC088, LIC088, LJC088, LKC088),
                ~ case_when(
                   as.character(.) == '70103' ~ 1,  # PSE as 1
                   is.na(.) ~ NA_integer_, # Retain NA
                   TRUE ~ 0  # All else as 0
                 ))) %>%
  # Create new column where any 1 in the row = TRUE, no 1 = FALSE
  mutate(unique_teachers = if_any(c(LBC089, LCC088, LDC088, LEC088, LFC088, LGC088, LHC088, LIC088, LJC088, LKC088), ~ . == 1)) %>%
  # Keep TRUE values
  filter(unique_teachers)

STUDYING_TEACHERS_2009
```

```{r}
# Looking at people who were at the time working as PS Teachers

LEGIT_TEACHERS_2009 <- LSAY2009 %>%
  # Selecting variables for kind of work
  select(STIDSTD, LBD014, LCD029, LDD029, LED029, LFD029, LGD029, LHD029, LID029, LJD029, LKD029) %>%
  # Mutate across the observation 
  mutate(across(c(LBD014, LCD029, LDD029, LED029, LFD029, LGD029, LHD029, LID029, LJD029, LKD029),
                ~ case_when(
                   as.character(.) == '2412' ~ 1,  # PSE as 1
                   is.na(.) ~ NA_integer_,
                   TRUE ~ 0  # All else as 0
                 ))) %>%
  # column for TRUE = legit teachers, FALSE = not teachers
  mutate(legit_teachers = if_any(c(LBD014, LCD029, LDD029, LED029, LFD029, LGD029, LHD029, LID029, LJD029, LKD029), ~ . == 1)) %>%
  # Filter for TRUE condition
  filter(legit_teachers)

LEGIT_TEACHERS_2009
```

```{r}
# Taking a look at what the legit teachers studied
teacher_jobs_2009 <- LSAY2009[LSAY2009$STIDSTD %in% LEGIT_TEACHERS_2009$STIDSTD, ]

# selecting student ID and area of study across the years
selected_columns <- c('STIDSTD', 'LBC089', 'LCC088', 'LDC088', 'LEC088', 'LFC088', 'LGC088', 'LHC088', 'LIC088', 'LJC088', 'LKC088')
teacher_jobs_2009 <- teacher_jobs_2009[, selected_columns]
```

What did they study?

| Code  | Field                            |
|-------|----------------------------------|
| 90701 | Psychology                       |
| 70199 | Teacher Education, n.e.c.        |
| 79999 | Education, n.e.c.                |
| 90503 | Children's Services              |
| 60501 | Pharmacy                         |
| 70103 | Teacher Education: Primary       |
| 70105 | Teacher Education: Secondary     |
| 61799 | Rehabilitation Therapies, n.e.c. |

\*\* revisit -- have to do proficiency standard \*\*

## Plausible values for 2009

```{r}
# Extracting the unique teacher IDs
teacher_ids_2009 <- LEGIT_TEACHERS_2009$STIDSTD

```

```{r}

LSAY2009_teachflag <- 
  LSAY2009 |> 
  mutate(teacher = if_else(STIDSTD %in% teacher_ids_2009, T, F))

Rrepest::Rrepest(data = LSAY2009_teachflag,
        svy = "PISA",
        est = est(c("mean","std"),"pv@math"),
        by = c("teacher"),
        cm.weights = c(paste0("w_fstr",1:80)),
        tabl = T)

```

```{r}
LSAY2009_proficiency <- 
  LSAY2009_teachflag |> 
  mutate(across(PV1MATH:PV5MATH,
                ~ if_else(. >= 482, "Proficient", "Not proficient", missing = NA_character_),
                .names = "{col}proficient"))

Rrepest::Rrepest(data = LSAY2009_proficiency,
        svy = "PISA",
        est = est("freq","pv@mathproficient"),
        by = "teacher",
        cm.weights = c(paste0("w_fstr",1:80)), # Our replicate weights have different names to those in PISA 2015 
        tabl = T)

```

# LSAY 2015

```{r}
LSAY2015 <- read_dta("data/lsay_data/2_LSAY_Y15_2022_STATA_01392_general.dta")
```

```{r}
# 2009 COHORT - exploring those who studied primary school teaching
STUDYING_TEACHERS_2015 <- LSAY2015 %>%
  # selecting variables for current area of study
  select(LSAYID, LCC088, LDC088, LEC088, LFC088, LGC088, LHC088) %>%
  # Mutate across the observation to replace 0 = not '70103', 1 = is '70103'
  mutate(across(c(LCC088, LDC088, LEC088, LFC088, LGC088, LHC088),
                ~ case_when(
                   as.character(.) == '70103' ~ 1,  # PSE as 1
                   is.na(.) ~ NA_integer_, # Retain NA
                   TRUE ~ 0  # All else as 0
                 ))) %>%
  # Create new column where any 1 in the row = TRUE, no 1 = FALSE
  mutate(unique_teachers = if_any(c(LCC088, LDC088, LEC088, LFC088, LGC088, LHC088), ~ . == 1)) %>%
  # Keep TRUE values
  filter(unique_teachers)

STUDYING_TEACHERS_2015
```

```{r}
# Looking at people who were at the time working as PS Teachers

LEGIT_TEACHERS_2015 <- LSAY2015 %>%
  # Selecting variables for kind of work
  select(LSAYID, LBEM004, LCD022, LDD022, LED022, LFD025, LGD022, LHD022) %>%
  # Mutate across the observation 
  mutate(across(c(LBEM004, LCD022, LDD022, LED022, LFD025, LGD022, LHD022),
                ~ case_when(
                   as.character(.) == '2412' ~ 1,  # PSE as 1
                   is.na(.) ~ NA_integer_,
                   TRUE ~ 0  # All else as 0
                 ))) %>%
  # column for TRUE = legit teachers, FALSE = not teachers
  mutate(legit_teachers = if_any(c(LBEM004, LCD022, LDD022, LED022, LFD025, LGD022, LHD022), ~ . == 1)) %>%
  # Filter for TRUE condition
  filter(legit_teachers)

LEGIT_TEACHERS_2015
```

```{r}
# Taking a look at what the legit teachers studied
teacher_jobs_2015 <- LSAY2015[LSAY2015$LSAYID %in% LEGIT_TEACHERS_2015$LSAYID, ]

# selecting student ID and area of study across the years
selected_columns <- c('LSAYID', 'LCC088', 'LDC088', 'LEC088', 'LFC088', 'LGC088', 'LHC088')
teacher_jobs_2015 <- teacher_jobs_2015[, selected_columns]
```

# Plausible values for 2015

```{r}
# Extracting the unique teacher IDs
teacher_ids_2015 <- LEGIT_TEACHERS_2015$LSAYID

```

```{r}

LSAY2015_teachflag <- 
  LSAY2015 |> 
  mutate(teacher = if_else(LSAYID %in% teacher_ids_2015, T, F))

Rrepest::Rrepest(data = LSAY2015_teachflag,
        svy = "PISA",
        est = est(c("mean","std"),"pv@math"),
        by = c("teacher"),
        cm.weights = c(paste0("w_fsturwt",1:80)),
        tabl = T)


```

```{r}
LSAY2015_proficiency <- 
  LSAY2015_teachflag |> 
  mutate(across(PV1MATH:PV5MATH,
                ~ if_else(. >= 482, "Proficient", "Not proficient", missing = NA_character_),
                .names = "{col}proficient"))

Rrepest::Rrepest(data = LSAY2015_proficiency,
        svy = "PISA",
        est = est("freq","pv@mathproficient"),
        by = "teacher",
        cm.weights = c(paste0("w_fsturwt",1:80)), 
        tabl = T)


```

## Quantiles Across the Years

```{r}
#2003
mathcut <- c(358, 420, 482, 545, 607, 669)

data_2003 <- pisa.per.pv(pvlabel = paste0("PV", 1:5, "MATH"), data = LSAY2003_teachflag, by = "teacher", per = c(10, 25, 75, 90))

data <- pisa.ben.pv(pvlabel= paste0("PV", 1:5, "MATH"), cutoff= mathcut, by="teacher", data=LSAY2003_teachflag)
```

```{r}
# BOXPLOT FOR 2003

data_2003_summary <- data_2003 %>%
  group_by(teacher) %>%
  summarize(
    ymin = min(Score),
    lower = Score[Percentiles == 25],
    middle = median(Score),
    upper = Score[Percentiles == 75],
    ymax = max(Score)
  )

ggplot(data_2003_summary, aes(x = as.factor(teacher))) +
  geom_boxplot(fill = 'orange', color = "black",
    aes(ymin = ymin, lower = lower, middle = middle, upper = upper, ymax = ymax),
    stat = "identity"
  ) +
  geom_hline(yintercept = 482, color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  labs(title = "Distribution of PISA Math Scores - 2003",
       x = "Teacher",
       y = "Score") +
  theme(legend.position = "none") +
  coord_flip()


```

```{r}

# Adapting data frame for plotting
data_2003 <- data_2003 |>
  rename(Percentiles = Percentiles, Score = Score, Std_err = 'Std. err.', teacher = teacher)

# Plot the data
base_chart <- ggplot(data_2003, aes(x = as.factor(Percentiles), y = Score, fill = as.factor(teacher))) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Score - Std_err, ymax = Score + Std_err), 
                position = position_dodge(0.9), width = 0.25, color = "black") +
  labs(title = "Scores at Different Percentiles by Teacher Status",
       subtitle = "PISA 2003 Math Scores for Teachers and Non-Teachers Across Percentiles",
       x = "Percentiles",
       y = "Score",
       fill = "Teacher") +
   geom_hline(yintercept = 482, linetype = "dashed", color = "red", size = 1)

base_chart +
  theme_grattan(chart_type =  "bar") +
  grattan_colour_manual(2) +
  grattan_y_continuous()

grattan_save_pptx(filename = "atlas/Y03PISAPercentiles.pptx")
```

```{r}
# 2006
data_2006 <- pisa.per.pv(pvlabel = paste0("PV", 1:5, "MATH"), data = LSAY2006_teachflag, by = "teacher", per = c(10, 25, 75, 90))

pisa.ben.pv(pvlabel= paste0("PV", 1:5, "MATH"), cutoff= mathcut, by="teacher", data=LSAY2006_teachflag)
```

```{r}
# BOXPLOT FOR 2006

data_2006_summary <- data_2006 %>%
  group_by(teacher) %>%
  summarize(
    ymin = min(Score),
    lower = Score[Percentiles == 25],
    middle = median(Score),
    upper = Score[Percentiles == 75],
    ymax = max(Score)
  )

ggplot(data_2006_summary, aes(x = as.factor(teacher))) +
  geom_boxplot(fill = 'orange', color = "black",
    aes(ymin = ymin, lower = lower, middle = middle, upper = upper, ymax = ymax),
    stat = "identity"
  ) +
  geom_hline(yintercept = 482, color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  labs(title = "Distribution of PISA Math Scores - 2006",
       x = "Teacher",
       y = "Score") +
  theme(legend.position = "none") +
  coord_flip()


```

```{r}
data_2006 <- data_2006 |>
  rename(Percentiles = Percentiles, Score = Score, Std_err = 'Std. err.', teacher = teacher)

# Plot the data
base_chart <- ggplot(data_2006, aes(x = as.factor(Percentiles), y = Score, fill = as.factor(teacher))) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Score - Std_err, ymax = Score + Std_err), 
                position = position_dodge(0.9), width = 0.25, color = "black") +
  labs(title = "Scores at Different Percentiles by Teacher Status",
       subtitle = "PISA 2006 Math Scores for Teachers and Non-Teachers Across Percentiles",
       x = "Percentiles",
       y = "Score",
       fill = "Teacher") +
   geom_hline(yintercept = 482, linetype = "dashed", color = "red", size = 1)

base_chart + 
  theme_grattan(chart_type =  "bar") +
  grattan_colour_manual(2) +
  grattan_y_continuous()
```

```{r}
# 2009
data_2009 <- pisa.per.pv(pvlabel = paste0("PV", 1:5, "MATH"), data = LSAY2009_teachflag, by = "teacher", per = c(10, 25, 75, 90))

pisa.ben.pv(pvlabel= paste0("PV", 1:5, "MATH"), cutoff= mathcut, by="teacher", data=LSAY2009_teachflag)
```

```{r}
# BOXPLOT FOR 2009

data_2009_summary <- data_2009 %>%
  group_by(teacher) %>%
  summarize(
    ymin = min(Score),
    lower = Score[Percentiles == 25],
    middle = median(Score),
    upper = Score[Percentiles == 75],
    ymax = max(Score)
  )

ggplot(data_2009_summary, aes(x = as.factor(teacher))) +
  geom_boxplot(fill = 'orange', color = "black",
    aes(ymin = ymin, lower = lower, middle = middle, upper = upper, ymax = ymax),
    stat = "identity"
  ) +
  geom_hline(yintercept = 482, color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  labs(title = "Distribution of PISA Math Scores - 2009",
       x = "Teacher",
       y = "Score") +
  theme(legend.position = "none") +
  coord_flip()


```

```{r}
data_2009 <- data_2009 |>
  rename(Percentiles = Percentiles, Score = Score, Std_err = 'Std. err.', teacher = teacher)

# Plot the data
base_chart_2009 <- ggplot(data_2009, aes(x = as.factor(Percentiles), y = Score, fill = as.factor(teacher))) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Score - Std_err, ymax = Score + Std_err), 
                position = position_dodge(0.9), width = 0.25, color = "black") +
  labs(title = "Scores at Different Percentiles by Teacher Status",
       subtitle = "PISA 2009 Math Scores for Teachers and Non-Teachers Across Percentiles",
       x = "Percentiles",
       y = "Score",
       fill = "Teacher") +
   geom_hline(yintercept = 482, linetype = "dashed", color = "red", size = 1)

base_chart_2009 + 
  theme_grattan(chart_type =  "bar") +
  grattan_colour_manual(2) +
  grattan_y_continuous()
```

```{r}
# Quantiles for 2015
data_2015 <- pisa.per.pv(pvlabel = paste0("PV", 1:10, "MATH"), data = LSAY2015_teachflag, by = "teacher", per = c(10, 25, 75, 90))

pisa.mean.pv(pvlabel = paste0("PV", 1:5, "MATH"), data = LSAY2003_teachflag, by = "teacher")

pisa.ben.pv(pvlabel= paste0("PV", 1:10, "MATH"), cutoff= mathcut, by="teacher", data=LSAY2015_teachflag)


```

```{r}
library(ggplot2)

# BOXPLOT FOR 2015

data_2015_summary <- data_2015 %>%
  group_by(teacher) %>%
  summarize(
    ymin = min(Score),
    lower = Score[Percentiles == 25],
    middle = median(Score),
    upper = Score[Percentiles == 75],
    ymax = max(Score)
  )

ggplot(data_2015_summary, aes(x = as.factor(teacher))) +
  geom_boxplot(fill = 'orange', color = "black",
    aes(ymin = ymin, lower = lower, middle = middle, upper = upper, ymax = ymax),
    stat = "identity"
  ) +
  geom_hline(yintercept = 482, color = "red", linetype = "dashed", size = 1) +
  theme_minimal() +
  labs(title = "Distribution of PISA Math Scores - 2015",
       x = "Teacher",
       y = "Score") +
  theme(legend.position = "none") +
  coord_flip()


```

```{r}
data_2015 <- data_2015 |>
  rename(Percentiles = Percentiles, Score = Score, Std_err = 'Std. err.', teacher = teacher)

# Plot the data
base_chart_2015 <- ggplot(data_2015, aes(x = as.factor(Percentiles), y = Score, fill = as.factor(teacher))) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Score - Std_err, ymax = Score + Std_err), 
                position = position_dodge(0.9), width = 0.25, color = "black") +
  labs(title = "Scores at Different Percentiles by Teacher Status",
       subtitle = "PISA 2015 Math Scores for Teachers and Non-Teachers Across Percentiles",
       x = "Percentiles",
       y = "Score",
       fill = "Teacher") +
   geom_hline(yintercept = 482, linetype = "dashed", color = "red", size = 1)

base_chart_2015 + 
  theme_grattan(chart_type =  "bar") +
  grattan_colour_manual(2) +
  grattan_y_continuous()
```

```{r}
# Manual t-test calculation for 2003
mean_FALSE <- 530.3
mean_TRUE <- 554.0
sd_FALSE <- 92.9
sd_TRUE <- 64.8
n_FALSE <- 10226
n_TRUE <- 144
se <- sqrt((92.9^2 / 10226) + (64.8^2 / 144)) # For Welch's t-test
t_value <- (mean_FALSE - mean_TRUE) / se

# approx dof
df <- ( (sd_FALSE^2 / n_FALSE) + (sd_TRUE^2 / n_TRUE) )^2 /
      ( ((sd_FALSE^2 / n_FALSE)^2 / (n_FALSE - 1)) + ((sd_TRUE^2 / n_TRUE)^2 / (n_TRUE - 1)) )

# p-value
p_value <- 2 * pt(t_value, df = df, lower.tail = TRUE)
p_value
t_value
```

```{r}
# Manual t-test calculation for 2006
#pisa.mean.pv(pvlabel = paste0("PV", 1:5, "MATH"), data = LSAY2006_teachflag, by = "teacher")

mean_FALSE <- 518.6
mean_TRUE <- 550.7
sd_FALSE <- 87.9
sd_TRUE <- 67.2
n_FALSE <- 14054
n_TRUE <- 116
se <- sqrt((87.9^2 / 14054) + (67.2^2 / 116)) # For Welch's t-test
t_value <- (mean_FALSE - mean_TRUE) / se

# approx dof
df <- ( (sd_FALSE^2 / n_FALSE) + (sd_TRUE^2 / n_TRUE) )^2 /
      ( ((sd_FALSE^2 / n_FALSE)^2 / (n_FALSE - 1)) + ((sd_TRUE^2 / n_TRUE)^2 / (n_TRUE - 1)) )

# p-value
p_value <- 2 * pt(t_value, df = df, lower.tail = TRUE)
p_value
t_value
```

```{r}
# Manual t-test calculation for 2009

#pisa.mean.pv(pvlabel = paste0("PV", 1:5, "MATH"), data = LSAY2009_teachflag, by = "teacher")
mean_FALSE <- 513.7
mean_TRUE <- 552.7
sd_FALSE <- 95.1
sd_TRUE <- 63.9
n_FALSE <- 14130
n_TRUE <- 121
se <- sqrt((95.1^2 / 14130) + (63.9^2 / 121)) # For Welch's t-test
t_value <- (mean_FALSE - mean_TRUE) / se

# approx dof
df <- ( (sd_FALSE^2 / n_FALSE) + (sd_TRUE^2 / n_TRUE) )^2 /
      ( ((sd_FALSE^2 / n_FALSE)^2 / (n_FALSE - 1)) + ((sd_TRUE^2 / n_TRUE)^2 / (n_TRUE - 1)) )

# p-value
p_value <- 2 * pt(t_value, df = df, lower.tail = TRUE)
p_value
t_value
```

```{r}
# Manual t-test calculation for 2015
pisa.mean.pv(pvlabel = paste0("PV", 1:5, "MATH"), data = LSAY2015_teachflag, by = "teacher")
mean_FALSE <- 494.0
mean_TRUE <- 519.4
sd_FALSE <- 92.5
sd_TRUE <- 61.0
n_FALSE <- 14503
n_TRUE <- 27
se <- sqrt((92.5^2 / 14503) + (61.0^2 / 27)) # For Welch's t-test
t_value <- (mean_FALSE - mean_TRUE) / se

# approx dof
df <- ( (sd_FALSE^2 / n_FALSE) + (sd_TRUE^2 / n_TRUE) )^2 /
      ( ((sd_FALSE^2 / n_FALSE)^2 / (n_FALSE - 1)) + ((sd_TRUE^2 / n_TRUE)^2 / (n_TRUE - 1)) )

# p-value
p_value <- 2 * pt(t_value, df = df, lower.tail = TRUE)
p_value
t_value

```

## Comparing Teacher Performance with other Professionals

Starting with 2003 first as it has the largest sample of teachers. looking at other professions at the end of the waves.

-   medical practitioners,

-   midwifery and nursing professionals

-   legal professionals,

-   accounts auditors and company secretaries

-   engineering professionals

| Professionals                             | ANSZCO Code |
|-------------------------------------------|-------------|
| Medical Practitioners                     | 253         |
| Midwifery and Nursing Professionals       | 254         |
| Legal professionals                       | 271         |
| accounts auditors and company secretaries | 221         |
| Engineering professionals                 | 233         |

```{r}
# Adapting the code earlier to see the frequency of each profession in the last wave
UNIQUE_PROFESSIONALS_Y03 <- LSAY2003 %>%
  # Selecting last wave variable related to question: 'What kind of work do you do?'
  select(STIDSTD, LKD029) %>%
  mutate(across(c(LKD029), as.character)) %>%
  mutate(profession = case_when(
    LKD029 == '2412' ~ 1,  # Teacher = 1
    startsWith(LKD029, '253')  ~ 2,  # Medical Practitioners = 2
    startsWith(LKD029, '254')  ~ 3,  # Midwifery and Nursing Professionals = 3
    startsWith(LKD029, '271')  ~ 4,  # Legal Professionals = 4
    startsWith(LKD029, '221')  ~ 5,  # Accounts Auditors and Company Secretaries = 5
    startsWith(LKD029, '233')  ~ 6,  # Engineering Professionals = 6
    is.na(LKD029) ~ NA_integer_, # NA values retained
    TRUE ~ 0 # All others = 0
  )) %>%
  # keeping 1:6 professions
  filter(profession != 0 & !is.na(profession))

# frequency of each profession
profession_frequency <- UNIQUE_PROFESSIONALS_Y03 %>%
  count(profession) %>%
  mutate(
    Profession = case_when(
      profession == 1 ~ 'Teacher',
      profession == 2 ~ 'Medical Practitioners',
      profession == 3 ~ 'Midwifery and Nursing Professionals',
      profession == 4 ~ 'Legal Professionals',
      profession == 5 ~ 'Accounts Auditors and Company Secretaries',
      profession == 6 ~ 'Engineering Professionals'
    )
  )
```

```{r}

# Adapting the code to include different professions
LSAY2003_profession_flag <- LSAY2003 %>%
  mutate(LKD029 = as.character(LKD029)) %>%
  mutate(profession = case_when(
    LKD029 == '2412' ~ 'Teacher',
    startsWith(LKD029, '253') ~ 'Medical Practitioners',
    startsWith(LKD029, '254') ~ 'Midwifery and Nursing Professionals',
    startsWith(LKD029, '271') ~ 'Legal Professionals',
    startsWith(LKD029, '221') ~ 'Accounts Auditors and Company Secretaries',
    startsWith(LKD029, '233') ~ 'Engineering Professionals',
    TRUE ~ 'Other'
  ))

Rrepest::Rrepest(
  data = LSAY2003_profession_flag,
  svy = "PISA",
  est = est(c("mean","std"),"pv@math"),
  by = c("profession"),
  cm.weights = c(paste0("w_fstr", 1:80)),
  tabl = TRUE
)
```

https://scc.ms.unimelb.edu.au/resources/graphs-for-statistical-analysis/graphs \* how to show standard error/explain simply

```{r}
#70th percentile
pisa.per.pv(pvlabel= paste0("PV",1:5,"MATH"),
per=c(10, 25, 70, 90), data= LSAY2003)
```

```{r}
# Finding how many teachers are above the 70th percentile: '582.26'
pisa.ben.pv(pvlabel= paste0("PV",1:5,"MATH"), cutoff=582.26, by="teacher", data=LSAY2003_teachflag)
```

pooled percentage for proficiency and high performance across all years:

| Year | Teachers | Percentage at or above 482 |
|------|----------|----------------------------|
| 2003 |          |                            |
| 2006 |          |                            |
| 2009 |          |                            |
| 2015 |          |                            |

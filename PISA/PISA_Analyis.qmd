---
title: "PISA"
format: html
editor: visual
---

## PISA ANALYSIS

```{r}
library(haven)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(grattantheme)
library(glue)
library(officer)
library(ggtext)
library(Rrepest)
library(intsvy)
# reading sav file
PISA2000 <- read_sav("data/CY01_AUS_PISA2000_StdQ_Achieve_and_SchQ_forPublic_Release.sav")
PISA2003 <- read_sav("data/CY02_AUS_PISA2003_StdQ_AchieveandSchQ_forPublic_Release.sav")
PISA2006 <- read_sav("data/CY03_AUS_PISA2006_StdQAchieve andSchQ_forPublicRelease.sav")
PISA2009_1 <- read_sav("data/PISA2009_ScQ_AUS_release.sav") #need to check
PISA2009_2 <- read_sav("data/PISA2009_StQ_AUS_release.sav") #need to check, has math vals
PISA2012 <- read_sav("data/PISA2012_StdQ_AUS.sav")
PISA2015 <- read_sav("data/CY6_MS_AUS_PISA2015_StudentandAchievementforPublicRelease.sav")
PISA2018 <- read_sav("data/CY7_MS_AUS_PISA2018_StudentandAchievement_PublicRelease.sav")
PISA2022 <- read_sav("data/CY08_MS_AUS_PISA 2022_Student_and_Achievement_Public.sav")


```

Monday: PISA 

**Download PISA data from ACER website and save to shared folder (2 hr)**

DONE the first

**Import each dataset (1 hr)**

DONE, except 2015 which didn't download.

**Filter for Year 10s (1hr) **

Looking for variable ST001D01T: 10

```{r}
# taking all the year 10s out of PISA 2000
PISA2000_Y10 <- PISA2000 %>% filter(st02q01 == 10)

# taking all the year 10s out of PISA 2003
PISA2003_Y10 <- PISA2003 %>% filter(ST01Q01 == 10)

# taking all the year 10s out of PISA 2006
PISA2006_Y10 <- PISA2006 %>% filter(ST01Q01 == 10)

# taking all the year 10s out of PISA 2009
PISA2009_2_Y10 <- PISA2009_2 %>% filter(ST01Q01 == 10)

# taking all the year 10s out of PISA 2012
PISA2012_Y10 <- PISA2012 %>% filter(ST01Q01 == 10)

PISA_2015_Y10 <- PISA2015 %>% filter(ST001D01T == 10)

# taking all the year 10s out of PISA 2018
PISA2018_Y10 <- PISA2018 %>% filter(ST001D01T == 10)

# taking all the year 10s out of PISA 2022
PISA2022_Y10 <- PISA2022 %>% filter(ST001D01T == 10)

# cleaning names

PISA2018_Y10 <- janitor::clean_names(PISA2018_Y10)
PISA_2015_Y10 <- janitor::clean_names(PISA_2015_Y10)
PISA2022_Y10 <- janitor::clean_names(PISA2022_Y10)

```


Get Mean + Confidence Interval for each year in literacy and numeracy (1 hr) 

```{r}


# Average Maths Scores for Y10s Across the Years
#2000
means_2000 <- Rrepest(data = PISA2000_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@math"),
        cm.weights = c(paste0("w_fstr", 1:80)))
#2003
means_2003 <- Rrepest(data = PISA2003_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@math"),
        cm.weights = c(paste0("w_fstr", 1:80)))
#2006
means_2006 <- Rrepest(data = PISA2006_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@math"),
        cm.weights = c(paste0("w_fstr", 1:80)))
#2009
means_2009 <- Rrepest(data = PISA2009_2_Y10, 
       svy = "PISA",
       est = est(c("mean", "std"), "pv@math"),
       cm.weights = c(paste0("w_fstr", 1:80)))

#2012
means_2012 <- Rrepest(data = PISA2012_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@math"),
        cm.weights = c(paste0("w_fstr", 1:80)))
#2015
means_2015 <- Rrepest(data = PISA_2015_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@math"),
        cm.weights = c(paste0("w_fsturwt",1:80)))
#2018
means_2018 <- Rrepest(data = PISA2018_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@math"),
        cm.weights = c(paste0("w_fsturwt", 1:80)))
#2022
means_2022 <- Rrepest(data = PISA2022_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@math"),
        cm.weights = c(paste0("w_fsturwt", 1:80)))




```

Combine rows (0.5 hr) 

```{r}
# Add Year column
means_2000$Year <- 2000
means_2003$Year <- 2003
means_2006$Year <- 2006
means_2009$Year <- 2009
means_2012$Year <- 2012
means_2015$Year <- 2015
means_2018$Year <- 2018
means_2022$Year <- 2022

all_means <- rbind(
  means_2000,
  means_2003,
  means_2006,
  means_2009,
  means_2012,
  means_2015,
  means_2018,
  means_2022
)


all_means$CI_Lower <- all_means$`b.mean.pv@math` - 1.96 * all_means$`se.mean.pv@math`
all_means$CI_Upper <- all_means$`b.mean.pv@math` + 1.96 * all_means$`se.mean.pv@math`

PISA_means <- all_means[, c("Year", ".", "b.mean.pv@math", "se.mean.pv@math", "b.std.pv@math", "se.std.pv@math", "CI_Lower", "CI_Upper")]

```

```{r}
# first version without the years formatting
ggplot(all_means, aes(x = Year, y = `b.mean.pv@math`)) +
  geom_point() +
  geom_errorbar(aes(ymin = CI_Lower, ymax = CI_Upper), width = 0.2) +
  labs(title = "Mean Math Scores Over Years with 95% Confidence Intervals",
       x = "Year", y = "Mean Math Score") +
  theme_minimal()
```


## Creating dataframe for year 10 literacy

```{r}
# Average Literacy Scores for Y10s Across the Years
#2000
readmeans_2000 <- Rrepest(data = PISA2000_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@read"),
        cm.weights = c(paste0("w_fstr", 1:80)))
#2003
readmeans_2003 <- Rrepest(data = PISA2003_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@read"),
        cm.weights = c(paste0("w_fstr", 1:80)))
#2006
readmeans_2006 <- Rrepest(data = PISA2006_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@read"),
        cm.weights = c(paste0("w_fstr", 1:80)))
#2009
readmeans_2009 <- Rrepest(data = PISA2009_2_Y10, 
       svy = "PISA",
       est = est(c("mean", "std"), "pv@read"),
       cm.weights = c(paste0("w_fstr", 1:80)))

#2012
readmeans_2012 <- Rrepest(data = PISA2012_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@read"),
        cm.weights = c(paste0("w_fstr", 1:80)))
#2015
readmeans_2015 <- Rrepest(data = PISA_2015_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@read"),
        cm.weights = c(paste0("w_fsturwt",1:80)))
#2018
readmeans_2018 <- Rrepest(data = PISA2018_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@read"),
        cm.weights = c(paste0("w_fsturwt", 1:80)))
#2022
readmeans_2022 <- Rrepest(data = PISA2022_Y10, 
        svy = "PISA",
        est = est(c("mean", "std"), "pv@read"),
        cm.weights = c(paste0("w_fsturwt", 1:80)))

```

```{r}
# Add Year column
readmeans_2000$Year <- 2000
readmeans_2003$Year <- 2003
readmeans_2006$Year <- 2006
readmeans_2009$Year <- 2009
readmeans_2012$Year <- 2012
readmeans_2015$Year <- 2015
readmeans_2018$Year <- 2018
readmeans_2022$Year <- 2022

all_readmeans <- rbind(
  readmeans_2000,
  readmeans_2003,
  readmeans_2006,
  readmeans_2009,
  readmeans_2012,
  readmeans_2015,
  readmeans_2018,
  readmeans_2022
)


all_readmeans$CI_Lower <- all_readmeans$`b.mean.pv@read` - 1.96 * all_readmeans$`se.mean.pv@read`
all_readmeans$CI_Upper <- all_readmeans$`b.mean.pv@read` + 1.96 * all_readmeans$`se.mean.pv@read`

PISA_readmeans <- all_readmeans[, c("Year", ".", "b.mean.pv@read", "se.mean.pv@read", "b.std.pv@read", "se.std.pv@read", "CI_Lower", "CI_Upper")]
```

Create national line charts for Y10 literacy and numeracy (2 hr) 


```{r}

# Plotting means and confidence intervals for year 10s across the years
yr10scores_ci <- ggplot(PISA_means, aes(x = Year, y = `b.mean.pv@math`)) +
  geom_point() +
  geom_line() +  
  geom_errorbar(aes(ymin = CI_Lower, ymax = CI_Upper), width = 0.2) +
  scale_x_continuous(breaks = all_means$Year) + 
  geom_label(aes(label = round(`b.mean.pv@math`, 1)), vjust = 0.75, size = 3) +
  labs(title = "Year 10's math scores have been declining over the years",
       subtitle = glue("{colour_text('#FF0000','PISA scores')} and {colour_text(grattan_orange, 'confidence intervals')} for year 10s across the years"),
       x = "Year", y = "Mean Math Score") +
  theme_minimal()

yr10scores_ci +
  theme_grattan(chart_type = "line") +
  grattan_colour_manual(2, faded_level = 2) +
  theme(axis.line = element_line(colour = "grey80")) +
  grattan_y_continuous() +
  theme(plot.subtitle = element_markdown(lineheight = 1.1)) +
  annotate("text", x = 2020, y = 502, label = "1 Year Delay Due to COVID-19", size = 5, color = "darkgrey", hjust = 0.5)

```
 
```{r}


year10_readscores <- ggplot(PISA_readmeans, aes(x = Year, y = `b.mean.pv@read`)) +
  geom_point() +
  geom_line() +  
  geom_errorbar(aes(ymin = CI_Lower, ymax = CI_Upper), width = 0.2) +
  scale_x_continuous(breaks = PISA_readmeans$Year) + 
  geom_label(aes(label = round(`b.mean.pv@read`, 1)), vjust = 0.75, size = 3) +
  labs(title = "Year 10's literacy scores show an overall decrease over time",
       subtitle = glue("{colour_text('#FF0000','PISA scores')} and {colour_text(grattan_orange, 'confidence intervals')} for year 10s across the years"),
       x = "Year", y = "Mean Literacy Score") +
  theme_minimal()

year10_readscores +
  theme_grattan(chart_type = "line") +
  grattan_colour_manual(2, faded_level = 2) +
  theme(axis.line = element_line(colour = "grey80")) +
  grattan_y_continuous() +
  theme(plot.subtitle = element_markdown(lineheight = 1.1)) +
  annotate("text", x = 2020, y = 511, label = "1 Year Delay Due to COVID-19", size = 5, color = "darkgrey", hjust = 0.5)



```
#Repeat for each state and territory and for the Catholics (National, Victoria and NSW) (7 hr)

```{r}

```

